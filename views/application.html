<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Loanratus Admin</title>
    <meta name="description" content="Loanratus Admin">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="apple-icon.png">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/themify-icons.css">
    <link rel="stylesheet" href="assets/css/flag-icon.min.css">
    <link rel="stylesheet" href="assets/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="assets/css/lib/datatable/dataTables.bootstrap.min.css">
    <!-- <link rel="stylesheet" href="assets/css/bootstrap-select.less"> -->
    <link rel="stylesheet" href="assets/scss/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv.min.js"></script> -->
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="css/jquery.fileupload.css">
    <link rel="stylesheet" href="css/jquery.fileupload-ui.css">
    <!-- CSS adjustments for browsers with JavaScript disabled -->
    <noscript><link rel="stylesheet" href="css/jquery.fileupload-noscript.css"></noscript>
    <noscript><link rel="stylesheet" href="css/jquery.fileupload-ui-noscript.css"></noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.3/jquery.fancybox.min.css">
    <style type="text/css">
        ul.nav li.active p{color: #ffffff;}
        a, a p, a h4, a:hover{color: rgb(66, 139, 202);}
        li.disabled a p, li.disabled a h4 {color: #878787;}
        li.active a h4 {color: #ffffff;}
        table{width: 100%;}
        table th{text-align: center;}
        .alert-success, .alert-success p {color: #155724;}
        .modal-dialog{
            left: 0;
        }
        .thumbnail {
            padding:0px;
        }
        .panel {
            position:relative;
        }
        .panel>.panel-heading:after,.panel>.panel-heading:before{
            position:absolute;
            top:11px;left:-16px;
            right:100%;
            width:0;
            height:0;
            display:block;
            content:" ";
            border-color:transparent;
            border-style:solid solid outset;
            pointer-events:none;
        }
        .panel>.panel-heading:after{
            border-width:7px;
            border-right-color:#f7f7f7;
            margin-top:1px;
            margin-left:2px;
        }
        .panel>.panel-heading:before{
            border-right-color:#ddd;
            border-width:8px;
        }
        select.form-control{
            height: 36px !important;
        }
        ul.timeline {
            list-style-type: none;
            position: relative;
        }
        ul.timeline:before {
            content: ' ';
            background: #d4d9df;
            display: inline-block;
            position: absolute;
            left: 29px;
            width: 2px;
            height: 100%;
            z-index: 400;
        }
        ul.timeline > li {
            margin: 20px 0;
            padding-left: 60px;
        }
        ul.timeline > li:before {
            content: ' ';
            background: white;
            display: inline-block;
            position: absolute;
            border-radius: 50%;
            border: 3px solid #22c0e8;
            left: 20px;
            width: 20px;
            height: 20px;
            z-index: 400;
        }
        ul#workflow-ul-list li{
            padding: 5px 0;
        }
        .carousel {
            margin-bottom: 0;
            padding: 0 40px 30px 40px;
        }
        .carousel-control {
            left: -12px;
            height: 40px;
            width: 40px;
            background: none repeat scroll 0 0 #222222;
            border: 4px solid #FFFFFF;
            border-radius: 23px 23px 23px 23px;
            margin-top: 90px;
        }
        .carousel-control.right {
            right: -12px;
        }
        .carousel-indicators {
            right: 50%;
            top: auto;
            bottom: -10px;
            margin-right: -19px;
        }
        .carousel-indicators li {
            background: #cecece;
        }
        .carousel-indicators .active {
            background: #428bca;
        }
        .badge-success {
            background-color: #28a745;
        }
        .badge-danger {
            background-color: #dc3545;
        }
        .badge-warning {
            background-color: #f0ad4e;
        }
        .pb-0{
            text-align: center;
        }
        input.invalid, span.invalid {
            border: 2px dashed red;
        }
    </style>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
<!-- Left Panel -->
    <script type="text/javascript">
        jQuery(document).ready(function($){ check(); loadMenus(); read_write();});
    </script>

<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default">

        <div class="navbar-header">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fa fa-bars"></i>
            </button>
            <a class="navbar-brand" href="/dashboard">Loanratus</a>
            <a class="navbar-brand hidden" href="/dashboard">35</a>
        </div>

        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul id="sidebar" class="nav navbar-nav">
            </ul>
        </div><!-- /.navbar-collapse -->
    </nav>
</aside><!-- /#left-panel -->
    <!-- Left Panel -->

    <!-- Right Panel -->
    <div id="right-panel" class="right-panel">
        <!-- Header-->
        <header id="header" class="header">

            <div class="header-menu">

                <div class="col-sm-7">
                    <a id="menuToggle" class="menutoggle pull-left"><i class="fa fa fa-tasks"></i></a>
                    <div class="header-left">
                        <button class="search-trigger"><i class="fa fa-search"></i></button>
                        <div class="form-inline">
                            <form class="search-form">
                                <input class="form-control mr-sm-2" type="text" placeholder="Search ..." aria-label="Search">
                                <button class="search-close" type="submit"><i class="fa fa-close"></i></button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-sm-5">
                    <div class="user-area dropdown float-right">
                        <strong id="user" style="margin-right:10px; vertical-align: sub"></strong>
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img class="user-avatar rounded-circle" src="images/admin.jpg" alt="User Avatar">
                        </a>

                        <div class="user-menu dropdown-menu">
                                <!-- <a class="nav-link" href="#"><i class="fa fa- user"></i>My Profile</a>

                                <a class="nav-link" href="#"><i class="fa fa- user"></i>Notifications <span class="count">13</span></a>

                                <a class="nav-link" href="#"><i class="fa fa -cog"></i>Settings</a> -->

                            <a class="nav-link pull-right" href="#" onclick="logout()"><i class="fa fa-power-off"></i> Logout</a>
                            <script type="text/javascript">
                                function logout() {
                                    localStorage.login = "0";
                                    window.location.href = "/logout";
                                }
                            </script>
                        </div>
                    </div>

                </div>
            </div>

        </header><!-- /header -->
        <!-- Header-->

        <div class="breadcrumbs">
            <div class="col-sm-4">
                <div class="page-header float-left">
                    <div class="page-title">
                        <h1>Application</h1>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="page-header float-right">
                    <div class="page-title">
                        <ol class="breadcrumb text-right">
                            <li><a href="#">Dashboard</a></li>
                            <li><a href="#">Users</a></li>
                            <li class="active"><a href="/all-applications">All Applications</a></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="content mt-3">
            <div class="animated fadeIn">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div style="float: left; margin: 0 15px;">
                                    <strong id="workflow-div-title" class="card-title">Workflow</strong>
                                    <p>Client ID#: <a onclick="goToClientProfile()" style="text-decoration: underline; cursor: pointer;"><span id="client-id"></span></a> | LOAN ID#: <span id="application-id"></span></p>
                                </div>
                                <button id="loan_closed" class ="btn btn-warning btn-lg" style="float: right; margin-top: 5px; display: none;" disabled="disabled"></button>
                                <div id="close_loan" class="btn-group write" style="float: right; display: none; margin-top: 5px;">
                                    <button type="button" class="btn btn-danger btn-lg dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Close Loan
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#payOffModal" onclick="openPayOffModal()">Pay Off</a>
                                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#writeOffModal" onclick="openWriteOffModal()">Write Off</a>
                                    </div>
                                </div>
                                <div id="next-actions" class="btn-group" style="float: right;">
                                    <button type="button" class="btn btn-success btn-lg dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <i class="fa fa-forward"></i>
                                    </button>
                                    <div id="stage-actions" class="dropdown-menu">
                                        <a class="dropdown-item next" href="#">Save & Proceed</a>
                                    </div>
                                </div>
                                <button id="current_stage" class ="btn btn-warning btn-lg" style="float: right;" disabled="disabled"></button>
                                <button class ="previous btn btn-danger btn-lg" style="float: right;"><i class="fa fa-backward"></i></button>
                                <button class ="cancel btn btn-danger btn-lg" style="float: right; margin-right: 5px;"><i class="fa fa-times"></i></button>
                                <span style="float: right; margin: 15px;">
                                    <a href="#" class="pull-right transitions-toggle">Show Transitions <i class="fa fa-chevron-down"></i></a>
                                    <a href="#" class="pull-right transitions-toggle" style="display: none;">Hide Transitions <i class="fa fa-chevron-up"></i></a>
                                </span>
                            </div>
                            <script type="text/javascript">
                                let $transitions_toggle = $('.transitions-toggle');
                                $transitions_toggle.click(function () {
                                    $('#transitions-list').toggle();
                                    $transitions_toggle.toggle();
                                });
                            </script>
                            <div class="card-body">
                                <div id="transitions-list" class="row form-group" style="display: none;">
                                    <div class="col-xs-12">
                                        <ul id="workflow-ul-list" class="nav nav-pills nav-justified thumbnail setup-panel"></ul>
                                    </div>
                                </div>
                                <div id="disbursement-cards" class="row setup-content" style="display: none;">
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="loan-amount-text" class="mb-0"></h3>
                                                <p class="text-light">Disbursed Amount</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="total-due-text" class="mb-0"></h3>
                                                <p class="text-light">Principal Balance</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="last-payment-text" class="mb-0"></h3>
                                                <p class="text-light">Last Payment</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="card text-white bg-flat-color-1">
                                            <div class="card-body pb-0">
                                                <h3 id="next-payment-date-text" class="mb-0"></h3>
                                                <p class="text-light">Next Payment Due Date</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="document-upload" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <h3 id="document-upload-text" style="margin-bottom: 5px;"></h3>
                                            <select id="stage-documents" class="form-control" required="required" style="margin: 15px 0;">
                                                <option selected="selected">-- Choose Document --</option>
                                            </select>
                                            <input id="stage-documents-others" class="form-control" placeholder="Document Title" style="margin: 15px 0; display: none;" />
                                            <form id="fileupload" method="POST" enctype="multipart/form-data">
                                                <div class="row fileupload-buttonbar">
                                                    <div class="col-lg-7">
                                                        <span class="btn btn-success fileinput-button">
                                                            <i class="glyphicon glyphicon-plus"></i>
                                                            <span>Add file</span>
                                                            <input id="document-file" type="file" name="files[]" multiple>
                                                        </span>
                                                        <button type="submit" class="btn btn-primary start">
                                                            <i class="glyphicon glyphicon-upload"></i>
                                                            <span>Start upload</span>
                                                        </button>
                                                        <button type="reset" class="btn btn-warning cancel">
                                                            <i class="glyphicon glyphicon-ban-circle"></i>
                                                            <span>Cancel upload</span>
                                                        </button>
                                                        <!--<button type="button" class="btn btn-danger delete">-->
                                                            <!--<i class="glyphicon glyphicon-trash"></i>-->
                                                            <!--<span>Delete</span>-->
                                                        <!--</button>-->
                                                        <!--<input type="checkbox" class="toggle">-->
                                                        <!-- The global file processing state -->
                                                        <span class="fileupload-process"></span>
                                                    </div>
                                                    <div class="col-lg-5 fileupload-progress fade">
                                                        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                                            <div class="progress-bar progress-bar-success" style="width:0%;"></div>
                                                        </div>
                                                        <div class="progress-extended">&nbsp;</div>
                                                    </div>
                                                </div>
                                                <table id="images-preview" role="presentation" class="table table-striped" style="margin: 0"><tbody class="files"></tbody></table>
                                                <table id="files-preview" role="presentation" class="table table-striped" style="margin: 0; display: none;"><tbody></tbody></table>
                                            </form>
                                        </div>
                                        <!-- The template to display files available for upload -->
                                        <script id="template-upload" type="text/x-tmpl">
                                            {% for (var i=0, file; file=o.files[i]; i++) { %}
                                                <tr class="template-upload fade">
                                                    <td>
                                                        <span class="preview"></span>
                                                    </td>
                                                    <td>
                                                        <p class="name">{%=file.name%}</p>
                                                        <strong class="error text-danger"></strong>
                                                    </td>
                                                    <td>
                                                        <p class="size">Processing...</p>
                                                        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
                                                    </td>
                                                    <td>
                                                        {% if (!i && !o.options.autoUpload) { %}
                                                            <button class="btn btn-primary start" disabled>
                                                                <i class="glyphicon glyphicon-upload"></i>
                                                                <span>Start</span>
                                                            </button>
                                                        {% } %}
                                                        {% if (!i) { %}
                                                            <button class="btn btn-warning cancel">
                                                                <i class="glyphicon glyphicon-ban-circle"></i>
                                                                <span>Cancel</span>
                                                            </button>
                                                        {% } %}
                                                    </td>
                                                </tr>
                                            {% } %}
                                        </script>
                                        <!-- The template to display files available for download -->
                                        <script id="template-download" type="text/x-tmpl">
                                            {% for (var i=0, file; file=o.files[i]; i++) { %}
                                                <tr class="template-download fade">
                                                    <td>
                                                        <span class="preview">
                                                            {% if (file.thumbnailUrl) { %}
                                                                <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                                                            {% } %}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <p class="name">
                                                            {% if (file.url) { %}
                                                                <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                                                            {% } else { %}
                                                                <span>{%=file.name%}</span>
                                                            {% } %}
                                                        </p>
                                                        {% if (file.error) { %}
                                                            <div><span class="label label-danger">Error</span> {%=file.error%}</div>
                                                        {% } %}
                                                    </td>
                                                    <td>
                                                        <span class="size">{%=o.formatFileSize(file.size)%}</span>
                                                    </td>
                                                    <td>
                                                       {% if (file.deleteUrl) { %}
                                                            <button class="btn btn-danger delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                                                                <i class="glyphicon glyphicon-trash"></i>
                                                                <span>Delete</span>
                                                            </button>
                                                            <input type="checkbox" name="delete" value="1" class="toggle">
                                                       {% } else { %}
                                                            <button class="btn btn-warning cancel">
                                                                <i class="glyphicon glyphicon-ban-circle"></i>
                                                                <span>Cancel</span>
                                                            </button>
                                                       {% } %}
                                                    </td>
                                                </tr>
                                            {% } %}
                                        </script>
                                        </div>
                                    </div>
                                <div class="row setup-content" id="schedule">
                                    <div class="col-xs-12">
                                        <div id="disburse-alert" class="alert alert-success" role="alert" style="display: none;">
                                            <h3 class="alert-heading">Loan has been disbursed!</h3>
                                            <p>Notifications would be sent to the user accounts related to this loan application to provide updates on this loan application.</p>
                                            <!--<hr>-->
                                            <!--<p class="mb-0">Please contact the admin for any issues with disbursement.</p>-->
                                        </div>
                                        <div class="col-md-12 well">
                                            <h2 class="text-center">Loan Overview
                                                <button id="collect-payment-button" class ="btn btn-primary" style="float: right; display: none;" onclick="goToLoanRepayment()">Collect Payment <i class="fa fa-money"></i></button>
                                                <span id="principal-total-text" style="font-size: 20px; float: right; margin: 5px 5px 0 0;"></span>
                                            </h2>
                                            <div id="loanSchedule" style="margin-top: 30px;"></div>
                                            <p id="reschedule-info" style="display: none;"></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="generate-schedule" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <h2 class="text-center">Upload Loan Schedule</h2>
                                                    <hr />
                                                    <div class="row">
                                                        <div class="col-sm-8">
                                                            <input type="file" id="csvUpload" style="display: inline-block"/>
                                                            <button id="uploadCSV" class="btn btn-info">Upload</button>
                                                            <button id="saveCSV" class="btn btn-success">Save</button>
                                                            <i id="csvLoader" class="fa fa-spinner fa-spin" style="display: none;"></i>
                                                        </div>
                                                        <div class="col-sm-4">
                                                            <a href="/Loan Schedule.csv" target="_blank" style="text-decoration: underline;">
                                                                Download Loan Schedule Template <i class="fa fa-cloud-download"></i></a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-12">
                                                    <div id="dvCSV" style="margin-top: 30px;"></div>
                                                    <hr />
                                                    <button id="btn-2" class="next btn btn-primary btn-lg">Save & Proceed</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="generate-schedule-v2" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <h2 class="text-center" style="margin-bottom: 15px;">Loan Reschedule
                                                <span id="reschedule-total-text" style="font-size: 20px; float: right; margin: 5px 5px 0 0;"></span>
                                            </h2>
                                            <div class="row">
                                                <div class="col-sm-3">
                                                    <input type="file" id="csvUpload2" style="display: inline-block"/>
                                                </div>
                                                <div class="col-sm-5">
                                                    <button id="rejectCSV2" class="btn btn-danger write" style="float: right;">Reject <i class="fa fa-times"></i></button>
                                                    <button id="approveCSV2" class="btn btn-success write" style="float: right;">Approve <i class="fa fa-check"></i></button>
                                                    <button id="saveCSV2" class="btn btn-primary" style="float: right;">Add <i class="fa fa-plus"></i></button>
                                                    <button id="uploadCSV2" class="btn btn-info" style="float: right;">Preview <i class="fa fa-eye-slash"></i></button>
                                                    <i id="csvLoader2" class="fa fa-spinner fa-spin" style="display: none;"></i>
                                                </div>
                                                <div class="col-sm-4">
                                                    <a href="/Loan Schedule.csv" target="_blank" style="text-decoration: underline;">
                                                        Download Loan Schedule Template <i class="fa fa-cloud-download"></i></a>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-12">
                                                    <div id="dvCSV2" style="margin-top: 30px;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row setup-content" id="files">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <h2 class="text-center" style="margin-bottom: 15px;">Uploaded Documents</h2>
                                            <div id="Carousel" class="carousel slide">
                                                <ol class="carousel-indicators"></ol>

                                                <!-- Carousel items -->
                                                <div class="carousel-inner"></div>

                                                <a data-slide="prev" href="#Carousel" class="left carousel-control">‹</a>
                                                <a data-slide="next" href="#Carousel" class="right carousel-control">›</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <script type="text/javascript">
                                    $(document).ready(function() {
                                        $('#Carousel').carousel({
                                            interval: 5000
                                        })
                                    });
                                </script>
                                <div class="row setup-content" id="denied" style="display: none;">
                                    <div class="col-xs-12">
                                        <div class="col-md-12 well">
                                            <div class="alert alert-danger" role="alert" style="margin-top: 15px;">
                                                <h3 class="alert-heading">Loan Application has been denied!</h3>
                                                <p>Notifications would be sent to the user accounts related to this loan application to provide updates on this loan request.</p>
                                                <hr>
                                                <p class="mb-0">Please contact the admin for any related issues.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <ul id="processes" class="timeline"></ul>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <span style="margin: 5px;">Comments</span>
                                <button class ="btn btn-info" style="float: right;" data-toggle="modal" data-target="#addCommentModal">Add Comment <i class="fa fa-comment"></i></button>
                            </div>
                            <div class="card-body">
                                <div id="comments"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- .animated -->
        <div id="wait" style=";width:150px;height:100px;position:absolute;top:50%;left:50%;padding:2px;"><img src='spinner.gif' width="100" height="100" style="background-color: transparent"/></div>
    </div><!-- .content -->
<!-- Right Panel -->

    <!-- Modal -->
    <div class="modal fade" id="addCommentModal" tabindex="-1" role="dialog" aria-labelledby="addCommentModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addCommentModalLabel">Post Comment</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Comment</label><strong style="color:red"> *</strong><span id="comment-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-comment"></i></div>
                                <textarea id="comment" class="form-control" required="required" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="comment()">Comment</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addDocumentModal" tabindex="-1" role="dialog" aria-labelledby="addDocumentModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addDocumentModalLabel">Add Document Title</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Document Title</label><strong style="color:red"> *</strong><span id="others-document-title-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-comment"></i></div>
                                <input id="others-document-title" class="form-control" placeholder="Document Title" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="setDocumentTitle()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="disburseModal" tabindex="-1" role="dialog" aria-labelledby="disburseModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="disburseModalLabel">Disburse Loan</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Actual Disbursement Amount</label>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="disbursement-amount" type="text" class="form-control" placeholder="0" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Choose a Funding Source</label><strong style="color:red"> *</strong><span id="funding-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <select id="funding" class="form-control" required="required">
                                    <option selected="selected">-- Select a Funding Source --</option>
                                    <option value="Default">Default</option>
                                    <option value="Secondary">Secondary</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Choose a Disbursement Channel</label><strong style="color:red"> *</strong><span id="channel-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <select id="channel" class="form-control" required="required">
                                    <option selected="selected">-- Select a Channel --</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Disbursement Date</label><strong style="color:red"> *</strong><span id="disbursement-date-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input type="date" id="disbursement-date" class="form-control" required="required">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="disburse()">Disburse</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="writeOffModal" tabindex="-1" role="dialog" aria-labelledby="writeOffModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="writeOffModalLabel">Write Off Loan</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Account Holders Name</label>
                            <div class="input-group">
                                <input id="writeoff-name" type="text" class="form-control" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Write Off Amount</label>
                            <div class="input-group">
                                <input id="writeoff-amount" type="text" class="form-control" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Notes</label>
                            <div class="input-group">
                                <textarea id="writeoff-notes" class="form-control" required="required" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="writeOffLoan()">Write Off</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="payOffModal" tabindex="-1" role="dialog" aria-labelledby="payOffModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="payOffModalLabel">Pay Off Loan</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Payoff Amount</label>
                            <div class="input-group">
                                <input id="payoff-amount" type="text" class="form-control" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Write off interest amount</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <input id="payoff-interest" type="number" class="form-control" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Enter Date</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <input id="payoff-date" type="date" class="form-control" required="required">
                            </div>
                            <small class="form-text text-muted">Note, repayment date cannot be a future date</small>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Choose a Disbursement Channel</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <select id="payoff-channel" class="form-control" required="required">
                                    <option selected="selected">-- Select a Channel --</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Include on-hand interest</label>
                            <div class="input-group">
                                <div class="radio">
                                    <label><input type="radio" name="payoff-include-interest" value="Daily">Daily</label>
                                </div>
                                <div class="radio">
                                    <label><input type="radio" name="payoff-include-interest" value="Monthly">Monthly</label>
                                </div>
                                <div class="radio">
                                    <label><input type="radio" name="payoff-include-interest" value="All">All</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Notes</label>
                            <div class="input-group">
                                <textarea id="payoff-notes" class="form-control" required="required" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="payOffLoan()">Pay Off</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invoiceHistory" tabindex="-1" role="dialog" aria-labelledby="invoiceHistoryLabel">
        <div class="modal-dialog modal-lg" role="document" style="width: 1005%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="invoiceHistoryLabel">Repayment History</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <table id="invoice-history" class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>Fees</th>
                            <th>Penalty</th>
                            <th>Paid By</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="history">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editHistory" tabindex="-1" role="dialog" aria-labelledby="editHistoryLabel">
        <div class="modal-dialog modal-lg" role="document" style="width: 1005%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="editHistoryLabel">Edit Schedule History</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <table id="edit-history" class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>Previous Principal</th>
                            <th>Previous Interest</th>
                            <th>Previous Fees</th>
                            <th>Previous Penalty</th>
                            <th>Previous Date Due</th>
                            <th>Modified By</th>
                            <th>Date Modified</th>
                        </tr>
                        </thead>
                        <tbody id="e-history">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/plugins.js"></script>
    <script src="assets/js/main.js"></script>


    <script src="assets/js/lib/data-table/datatables.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.buttons.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/jszip.min.js"></script>
    <script src="assets/js/lib/data-table/pdfmake.min.js"></script>
    <script src="assets/js/lib/data-table/vfs_fonts.js"></script>
    <script src="assets/js/lib/data-table/buttons.html5.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.print.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.colVis.min.js"></script>
    <script src="assets/js/lib/data-table/datatables-init.js"></script>

    <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
    <script src="js/vendor/jquery.ui.widget.js"></script>
    <!-- The Templates plugin is included to render the upload/download listings -->
    <script src="https://blueimp.github.io/JavaScript-Templates/js/tmpl.min.js"></script>
    <!-- The Load Image plugin is included for the preview images and image resizing functionality -->
    <script src="https://blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js"></script>
    <!-- The Canvas to Blob plugin is included for image resizing functionality -->
    <script src="https://blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="js/jquery.fileupload.js"></script>
    <!-- The File Upload processing plugin -->
    <script src="js/jquery.fileupload-process.js"></script>
    <!-- The File Upload image preview & resize plugin -->
    <script src="js/jquery.fileupload-image.js"></script>
    <!-- The File Upload audio preview plugin -->
    <script src="js/jquery.fileupload-audio.js"></script>
    <!-- The File Upload video preview plugin -->
    <script src="js/jquery.fileupload-video.js"></script>
    <!-- The File Upload validation plugin -->
    <script src="js/jquery.fileupload-validate.js"></script>
    <!-- The File Upload user interface plugin -->
    <script src="js/jquery.fileupload-ui.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.3/jquery.fancybox.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            loadUsers();
            loadComments();
        });

        $(document).ajaxStart(function(){
            $("#wait").css("display", "block");
        });

        $(document).ajaxComplete(function(){
            $("#wait").css("display", "none");
        });

        const urlParams = new URLSearchParams(window.location.search);
        const application_id = urlParams.get('id');

        function goToLoanRepayment() {
            window.location.href = '/loan-repayment?id='+application_id;
        }

        function check(){
            if (localStorage.getItem('role') !== 1){
                jQuery('#car-models').hide();
                jQuery('#new-user').hide();
                jQuery('#models-card').hide();
                jQuery('#user').html(localStorage.getItem("name"));
            }
            else{
                jQuery('#user').html(localStorage.getItem("name"));
            }
        }

        function loadMenus(){
            let modules = {};
            modules = JSON.parse(localStorage.getItem("modules"));
            modules.forEach(function(k, v){
                if (k.menu_name === 'Sub Menu'){
                    let main = $.grep(modules, function(e){return e.id === parseInt(k.main_menu);});
                    $('#'+$(main[0]['module_tag']).attr('id') + ' > .sub-menu').append(k.module_tag);
                }else if(k.menu_name === 'Main Menu'){
                    $('#sidebar').append(k.module_tag);
                    $('#'+$(k.module_tag).attr('id')).append('<ul class="sub-menu children dropdown-menu"></ul>');
                }else{
                    $('#'+k.module_name).show();
                }
            });
            $.ajax({
                type: "GET",
                url: "/user/all-requests",
                success: function (response) {
                    $.each(response, function(k,v){
                        $('#requests-badge').html(v.requests);
                    });
                }
            });
            $.ajax({
                type: "GET",
                url: "/user/all-applications",
                success: function (response) {
                    $.each(response, function(k,v){
                        $('#applications-badge').html(v.applications);
                    });
                }
            });
        }

        function isUriImage(uri) {
            uri = uri.split('?')[0];
            let parts = uri.split('.'),
                extension = parts[parts.length-1],
                imageTypes = ['jpg','jpeg','tiff','png','gif','bmp'];
            if(imageTypes.indexOf(extension) !== -1)
                return true;
        }

        let workflow,
            application;

        function loadUsers(){
            $.ajax({
                'url': '/user/application-id/'+application_id,
                'type': 'get',
                'success': function (result) {
                    let data = result.response,
                        file_names = Object.keys(data.files),
                        files_count = file_names.length,
                        $carousel_inner = $('.carousel-inner'),
                        $carousel_indicators = $('.carousel-indicators');

                    application = data;
                    getWorkflows(application);
                    loadWorkflowState();

                    $('#client-id').text(padWithZeroes(application.userID,6));
                    $('#application-id').text(padWithZeroes(application.ID,9));
                    if (application.reschedule_amount){
                        $('#reschedule-info').show();
                        $('#reschedule-info').text('Reschedule Add-on amount is ₦'+(parseFloat(application.reschedule_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')+
                            ' last updated on '+application.date_modified);
                    }

                    if (application.schedule && application.schedule[0]){
                        $("#generate-schedule").hide();
                        $("#schedule").show();
                    } else {
                        $("#generate-schedule").show();
                    }

                    if (files_count < 1){
                        $carousel_inner.append('<h3>No Documents Uploaded Yet!</h3>');
                    } else {
                        let count = 0,
                            pages = parseInt(((files_count).roundTo(4))/4);
                        for (let i=1; i<=pages; i++){
                            if (i === 1){
                                $carousel_inner.append('<div class="item active"><div class="row page-1"></div></div>');
                                $carousel_indicators.append('<li data-target="#Carousel" data-slide-to="1" class="active"></li>');
                            } else {
                                $carousel_inner.append('<div class="item"><div class="row page-'+i+'"></div></div>');
                                $carousel_indicators.append('<li data-target="#Carousel" data-slide-to="'+i+'"></li>');
                            }
                            for (let j=0; j<4; j++){
                                if (count < files_count){
                                    let file_name = file_names[count],
                                        file = application.files[file_name];
                                    if (isUriImage(file)){
                                        $('.page-'+i).append('<div class="col-md-3"><a class="thumbnail grouped_elements" rel="grouped_elements" data-toggle="tooltip" data-placement="bottom" title="Click to Expand!" href="'+file+'"><img src="'+file+'" alt="'+file_name.replace(/_/g, ' ')+'" style="max-width:100%; height: 200px;"></a><p style="text-align: center;">'+file_name.replace(/_/g, ' ')+'</p></div>');
                                    } else {
                                        $('.page-'+i).append('<div class="col-md-3"><a class="thumbnail" data-target="_blank" data-toggle="tooltip" data-placement="bottom" title="Click to Download!" href="'+file+'" style="padding: 25px 0;"><i class="fa fa-file" style="font-size: 150px; display: block; text-align: center;"></i></a><p style="text-align: center;">'+file_name.replace(/_/g, ' ')+'</p></div>');
                                    }
                                }
                                count++;
                                if (count === files_count){
                                    $("a.grouped_elements").fancybox();
                                    $('.thumbnail').tooltip();
                                }
                            }
                        }
                    }

                    initCSVUpload(application);
                    initCSVUpload2(application);
                },
                'error': function (err) {
                    console.log('Error');
                }
            });
        }

        function goToClientProfile() {
            window.location.href = '/client-info?id='+application.userID;
        }

        function getWorkflows(data){
            $.ajax({
                type: "GET",
                url: "/workflows",
                success: function (response) {
                    localStorage.setItem("workflows",JSON.stringify(response.response));
                    let fullname = data.fullname || '';
                    workflow = (response.response)? ($.grep(response.response, function(e){ return e.ID === data.workflowID; }))[0] : {name:'Workflow'};
                    $("#workflow-div-title").text(fullname.toUpperCase()+" ("+workflow.name+")");
                }
            });
        }

        function loadComments(comments) {
            if (comments && comments[0]){
                let $comments = $('#comments');
                $comments.html('');
                comments.forEach(function (comment) {
                    $comments.append('<div class="row">\n' +
                        '    <div class="col-sm-2">\n' +
                        '        <div class="thumbnail"><img class="img-responsive user-photo" src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png"></div>\n' +
                        '    </div>\n' +
                        '    <div class="col-sm-10">\n' +
                        '        <div class="panel panel-default">\n' +
                        '            <div class="panel-heading"><strong>'+comment.fullname+'</strong> <span class="text-muted">commented on '+comment.date_created+'</span></div>\n' +
                        '            <div class="panel-body">'+comment.text+'</div>\n' +
                        '        </div>\n' +
                        '    </div>\n' +
                        '</div>');
                });
            } else {
                $.ajax({
                    'url': '/user/application/comments/'+application_id,
                    'type': 'get',
                    'success': function (data) {
                        let comments = data.response,
                            $comments = $('#comments');
                        $comments.html('');
                        if (!comments[0])
                            return $comments.append('<h2 style="margin: auto;">No comments available yet!</h2>');
                        comments.forEach(function (comment) {
                            $comments.append('<div class="row">\n' +
                                '    <div class="col-sm-2">\n' +
                                '        <div class="thumbnail"><img class="img-responsive user-photo" src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png"></div>\n' +
                                '    </div>\n' +
                                '    <div class="col-sm-10">\n' +
                                '        <div class="panel panel-default">\n' +
                                '            <div class="panel-heading"><strong>'+comment.fullname+'</strong> <span class="text-muted">commented on '+comment.date_created+'</span></div>\n' +
                                '            <div class="panel-body">'+comment.text+'</div>\n' +
                                '        </div>\n' +
                                '    </div>\n' +
                                '</div>');
                        });
                    },
                    'error': function (err) {
                        console.log('Error');
                        swal('No internet connection','','error');
                    }
                });
            }
        }

        let stage_documents = [];
        $('.next').hide();
        $('.previous').hide();
        $('#next-actions').hide();
        $('#current_stage').hide();
        function loadWorkflowStages(state) {
            $.ajax({
                'url': '/workflow-stages/'+state.workflowID,
                'type': 'get',
                'success': function (data) {
                    let count = 0,
                        workflow_stages = data.response;
                    workflow_stages.push({name:"Denied",stageID:4,stage_name:"Denied",workflowID:state.workflowID,approverID:1});

                    let ul = document.getElementById('workflow-ul-list'),
                        $last_btn = $("#btn-"+workflow_stages[workflow_stages.length-1]['stageID']),
                        stage = ($.grep(workflow_stages, function(e){ return e.stageID === state.current_stage; }))[0];

                    if ((!stage.actions || !stage.actions[0]) && (stage.stage_name !== 'Disbursal'))
                        $('.next').show();
                    $('.previous').show();
                    $('#next-actions').show();
                    $('#current_stage').show();

                    $last_btn.hide();
                    $('#current_stage').text(stage.name);
                    if (stage.stage_name === 'Application Start' && (!application.schedule || !application.schedule[0])){
                        $('#schedule').hide();
                        $('#generate-schedule').show();
                    }

                    if (stage.document){
                        let documents = stage.document.split(',');
                        $('#document-upload').show();
                        $('#document-upload-text').append('<i class="fa fa-warning"></i> Kindly upload '+documents.join(', '));
                        documents.forEach(function (document) {
                            if (document.replace(/ /g, '_') in application.files){
                                $('#stage-documents').append('<option value = "'+document+'">'+document+' &nbsp; (&check;)</option>');
                            } else {
                                $('#stage-documents').append('<option value = "'+document+'">'+document+'</option>');
                            }
                            stage_documents.push(document);
                        });
                        $('#stage-documents').append('<option value = "others">Others</option>');
                        fileUpload();
                    }

                    if (stage.actions){
                        let actions = stage.actions.split(',');
                        actions.forEach(function (id) {
                            let stage_template = ($.grep(workflow_stages, function(e){ return e.stageID === parseInt(id); }))[0];
                            if (stage_template){
                                $('#stage-actions').append('<a href="#" class="dropdown-item" id="stage-action-'+stage_template.stageID+'">'
                                    +stage_template.name+' ('+stage_template.stage_name+')</a>');
                            }
                        });
                    }

                    $("#stage-actions").on('click', function (e) {
                        let id = (e.target.id.split('-'))[2];
                        if (!id){
                            nextStage(state);
                        } else {
                            if (id !== '0')
                                nextStage(state, workflow_stages, id);
                        }
                    });

                    workflow_stages.forEach(function (stage) {
                        if (stage.stage_name !== 'Denied'){
                            let index =  workflow_stages.map(function(e) { return e.stageID; }).indexOf(state.current_stage),
                                li = document.createElement('li');
                            if (count === index){
                                li.className = "active";
                                if (count === 0)
                                    $(".previous").hide();
                                if (count === workflow_stages.length-1)
                                    $(".next").hide();
                            } else if (count > index) {
                                li.className = "disabled";
                            }
                            ul.appendChild(li);
                            count++;
                            li.innerHTML += '<a><h4 class="list-group-item-heading">Step '+count+'</h4>\n' +
                                '<p class="list-group-item-text">'+stage.name+'<br> ('+stage.stage_name+')</p></a>';}
                    });

                    if (stage.stage_name === 'Denied'){
                        $("#current_stage").hide();
                        $("#next-actions").hide();
                        $("#schedule").hide();
                        $("#denied").show();
                        $("#files").hide();
                        $(".next").hide();

                        $('.previous').append('<span> RE-OPEN</span>');

                        let li = document.createElement('li');
                        li.className = "active";
                        ul.appendChild(li);
                        li.innerHTML += '<a><h4 class="list-group-item-heading">Step '+(count+1)+'</h4>\n' +
                            '<p class="list-group-item-text">'+stage.name+'<br> ('+stage.stage_name+')</p></a>';
                    }

                    if (application.status === 0){
                        $("#next-actions").hide();
                        $('.previous').hide();
                        $('.cancel').hide();
                        $(".next").hide();
                        $("#current_stage").html('<span>CANCELLED</span>');
                    }

                    if (stage.stage_name === 'Disbursal'){
                        if (application.status === 2){
                            $('#collect-payment-button').show();
                            $('#generate-schedule-v2').show();
                            $('#disbursement-cards').show();
                            $('#disburse-alert').show();
                            $("#current_stage").hide();
                            $("#next-actions").hide();
                            $(".previous").hide();
                            $(".cancel").hide();
                            $(".next").hide();

                            if (application.close_status === 0){
                                $('#close_loan').show();
                            } else {
                                $('#loan_closed').show();
                                $('#collect-payment-button').text('View Collection');
                                $('#collect-payment-button').addClass('btn-secondary');
                                $('#collect-payment-button').removeClass('btn-primary');
                                $('#generate-schedule-v2').hide();
                                if (application.close_status === 1){
                                    $('#loan_closed').html('<strong>CLOSED </strong> | PAID OFF');
                                } else if (application.close_status === 2){
                                    $('#loan_closed').html('<strong>CLOSED </strong> | WRITTEN OFF');
                                }
                            }
                            checkTotalDue();
                        }
                        $('#disbursement-amount').val((parseFloat(application.loan_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                        $('#stage-actions').append('<a href="#" id="stage-action-0" class="dropdown-item" data-toggle="modal" data-target="#disburseModal">Disburse Loan</a>');
                    }

                    loadAllWorkflowState(workflow_stages);
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection','','error');
                }
            });
        }

        $('.cancel').on('click', function(e) {
            swal({
                title: "Are you sure?",
                text: "Once cancelled, this process is not reversible!",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
            .then((yes) => {
                if (yes) {
                    $.ajax({
                        'url': '/user/application/cancel/'+application_id,
                        'type': 'get',
                        'success': function (data) {
                            swal('Loan cancelled successfully','','success');
                            window.location.reload();
                        },
                        'error': function (err) {
                            console.log('Error');
                            swal('No internet connection','','error');
                        }
                    });
                }
            });
        });


        function loadWorkflowState() {
            $.ajax({
                'url': '/user/workflow_process/'+application_id,
                'type': 'get',
                'success': function (data) {
                    let states = data.response,
                        state = states[states.length-1],
                        allWells = $('.setup-content');

                    loadWorkflowStages(state);
                    allWells.hide();

                    $('.previous').on('click', function(e) {
                        previousStage(state,states);
                    });

                    $('#schedule').show();
                    $('#files').show();
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection','','error');
                }
            });
        }

        function loadAllWorkflowState(workflow_stages) {
            $.ajax({
                'url': '/user/workflow_process_all/'+application_id,
                'type': 'get',
                'success': function (data) {
                    let states = data.response,
                        $processes = $('#processes');

                    $processes.html('');
                    if (!states[0])
                        return $processes.append('<h3 style="margin: auto;">No transitions available yet!</h3>');
                    states.forEach(function (state) {
                        let previous_stage = ($.grep(workflow_stages, function(e){ return e.stageID === state.previous_stage; }))[0] || {stage_name:'N/A'},
                            current_stage = ($.grep(workflow_stages, function(e){ return e.stageID === state.current_stage; }))[0] || {stage_name:''},
                            by = (state.agentID)? ' by '+state.agent : '';
                        $processes.append('<li>\n' +
                            '    <p><a href="#">'+current_stage.stage_name+'</a></p>\n' +
                            '    <p><a href="#">'+state.date_created+'</a></p>\n' +
                            '    <p>Moved from '+previous_stage.stage_name+' to '+current_stage.stage_name+by+'</p>\n' +
                            '</li>');
                    });
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection','','error');
                }
            });
        }

        function nextStage(state, workflow_stages, action_stage) {
            let stage = {};
            if (workflow_stages && action_stage){
                stage.previous_stage = state.current_stage;
                stage.current_stage = parseInt(action_stage);
            }
            if (stage_documents[0]){
                for (let i=0; i<stage_documents.length; i++){
                    if (!(stage_documents[i].replace(/ /g, '_') in application.files))
                        return swal('Kindly upload required document ('+stage_documents+')','','warning');
                }
            }
            if (!application.schedule || (application.schedule && !application.schedule[0]))
                return swal('Kindly upload loan schedule to proceed!','','warning');
            $.ajax({
                'url': '/user/workflow_process/'+application_id+'/'+state.workflowID,
                'type': 'post',
                'data': {stage: stage, user_role:localStorage.getItem('role'), agentID:(JSON.parse(localStorage.getItem("user_obj"))).ID},
                'success': function (data) {
                    if (data.status === 200){
                        $('#document-upload').hide();
                        $('#document-upload-text').text('');
                        swal('Workflow updated successfully!','','success');
                        window.location.reload();
                    } else {
                        if (data.message){
                            swal(data.message,'','info');
                        } else {
                            swal('No internet connection','','error');
                        }
                    }
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection','','error');
                }
            });
        }

        function previousStage(state,states) {
            $.ajax({
                'url': '/user/revert_workflow_process/'+application_id,
                'type': 'get',
                'success': function (data) {
                    if (data.status === 200){
                        $('#document-upload').hide();
                        $('#document-upload-text').text('');
                        swal('Workflow updated successfully!','','success');
                        window.location.reload();
                    } else {
                        if (data.message){
                            swal(data.message,'','info');
                        } else {
                            swal('No internet connection','','error');
                        }
                    }
                },
                'error': function (err) {
                    console.log('Error');
                    swal('No internet connection','','error');
                }
            });
        }

        function comment(){
            let $comment = $("#comment"),
                comment = $comment.val();
            if (!comment || comment === ""){
                $comment.val("");
                return swal('Kindly type a brief comment','','error');
            }
            $.ajax({
                'url': '/user/application/comments/'+application_id+'/'+(JSON.parse(localStorage.getItem('user_obj')))['ID'],
                'type': 'post',
                'data': {text: comment},
                'success': function (data) {
                    let comments = data.response;
                    results = comments;
                    loadComments(comments);
                    $comment.val("");
                    swal('Comment saved successfully','','success');
                },
                'error': function (err) {
                    $comment.val("");
                    swal('Oops! An error occurred while saving comment','','error');
                }
            });
        }

        let stage_file_name,
            document_others = false;
        $('#fileupload').click(function () {
            let document = $('#stage-documents').val(),
                $others = $('#stage-documents-others');

            if (!document || (document === '-- Choose Document --'))
                return swal('Ensure you choose documents to be uploaded from the list','','warning');

            if ((document === 'others') && !$others.val())
                return swal('Ensure you input the document title','','warning');
        });
        
        function setDocumentTitle() {
            let $title = $('#others-document-title');
            if (!$title.val())
                return swal('Document title cannot be empty','','warning');
            $('#stage-documents-others').val($title.val());
            fileUpload($title.val());
        }

        $('#stage-documents-others').click(function () {
            $('#addDocumentModal').modal('show');
        });

        $('#stage-documents').change(function () {
            let $othersModal = $('#addDocumentModal'),
                $others = $('#stage-documents-others');
            if (this.value === "others"){
                $others.show();
                $others.val('');
                document_others = true;
                $othersModal.modal('show');
            } else {
                $others.hide();
                document_others = false;
            }
            stage_file_name = this.value;
            fileUpload(this.value);
        });

        function formatBytes(a,b){if(0==a)return"0 Bytes";var c=1024,d=b||2,e=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],f=Math.floor(Math.log(a)/Math.log(c));return parseFloat((a/Math.pow(c,f)).toFixed(d))+" "+e[f]}

        $('#document-file').change(function () {
            let _self = this,
                $images_preview = $('#images-preview'),
                $files_preview = $('#files-preview');
            console.log(this.files)
            if (this.files[0].type && (this.files[0].type).split('/') && ((this.files[0].type).split('/'))[0]){
                if (((this.files[0].type).split('/'))[0] !== 'image'){
                    $images_preview.hide();
                    $files_preview.show();
                    $files_preview.find('tbody').html('');
                    $images_preview.find('tbody').html('');
                    $files_preview.find('tbody').append('<tr class="template-upload fade in">\n' +
                        '    <td><span class="preview"><i style="font-size:70px" class="fa fa-file"></i></span></td>\n' +
                        '    <td><p class="name">'+this.files[0].name+'</p></td>\n' +
                        '    <td><p class="size">'+formatBytes(this.files[0].size)+'</p><div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div></td>\n' +
                        '    <td><button class="btn btn-primary start"><i class="glyphicon glyphicon-upload"></i><span>Start</span></button>\n' +
                        '        <button class="btn btn-warning cancel"><i class="glyphicon glyphicon-ban-circle"></i><span>Cancel</span></button></td>\n' +
                        '</tr>');

                    $('.start').click(function (e) {
                        e.preventDefault();

                        let stage_document_name,
                            formData = new FormData(),
                            document = stage_file_name,
                            others = $('#stage-documents-others').val();

                        if (document_others){
                            stage_document_name = (others)? others.replace(/ /g, '_') : '';
                        } else {
                            stage_document_name = (document && document !== '-- Choose Document --')? document.replace(/ /g, '_') : '';
                        }

                        formData.append('files[]', _self.files[0]);
                        $.ajax({
                            url: 'document-upload/'+application_id+'/'+stage_document_name,
                            type: "POST",
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                swal("File uploaded successfully!","","success");
                                window.location.reload();
                            },
                            error: function() {
                                swal("Error! Please Try Again","","error");
                            }
                        });
                    });

                    $('.cancel').click(function (e) {
                        e.preventDefault();
                        $files_preview.find('tbody').html('');
                    });
                } else {
                    $images_preview.show();
                    $files_preview.hide();
                    $files_preview.find('tbody').html('');
                    $images_preview.find('tbody').html('');
                }
            } else {
                return swal('Kindly upload a valid file format','','warning');
            }
        });

        function fileUpload(document) {
            let stage_document_name,
                $fileupload = $('#fileupload'),
                others = $('#stage-documents-others').val();

            if (document_others){
                stage_document_name = (others)? others.replace(/ /g, '_') : '';
            } else {
                stage_document_name = (document && document !== '-- Choose Document --')? document.replace(/ /g, '_') : '';
            }

            $fileupload.fileupload({
                url: 'document-upload/'+application_id+'/'+stage_document_name,
                disableImageResize: /Android(?!.*Chrome)|Opera/
                    .test(window.navigator.userAgent),
                maxFileSize: 999000,
                acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i
            });

            $fileupload.addClass('fileupload-processing');
            $.ajax({
                url: $fileupload.fileupload('option', 'url'),
                context: $fileupload[0]
            }).always(function () {
                $(this).removeClass('fileupload-processing');
            }).done(function (result) {
                $(this).fileupload('option', 'done')
                    .call(this, $.Event('done'), {result: result});
            });
        }

        function initCSVUpload(application) {
            let schedule = [],
                $dvCSV = $("#dvCSV"),
                $saveCSV = $("#saveCSV"),
                $csvUpload = $("#csvUpload"),
                $uploadCSV = $("#uploadCSV"),
                $csvLoader = $("#csvLoader");

            $uploadCSV.bind("click", function () {
                schedule = [];
                let regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
                if (regex.test($csvUpload.val().toLowerCase())) {
                    if (typeof (FileReader) !== "undefined") {
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            let table = $("<table border='1' style='text-align: center;'/>"),
                                rows = e.target.result.split("\n");
                            for (let i = 0; i < rows.length; i++) {
                                let invoice = {},
                                    row = $("<tr />"),
                                    cells = rows[i].split(",");
                                if (i === 0) {
                                    cells = ["PRINCIPAL","INTEREST","BALANCE"];
                                } else if (i === 1) {
                                    cells = ["INVOICE DATE","COLLECTION DATE","AMOUNT","INVOICE DATE","COLLECTION DATE","AMOUNT","AMOUNT"];
                                }
                                for (let j = 0; j < cells.length; j++) {
                                    let cell = $("<td />");
                                    if (i === 0){
                                        if ((cells[j] === "PRINCIPAL") || cells[j] === "INTEREST")
                                            cell = $("<td colspan='3' />");
                                    }
                                    if (cells[j]){
                                        if (i > 1){
                                            if (j === 0 || j === 1 || j === 3 || j === 4){
                                                cell.html('<input id="invoice-'+i+'-'+j+'" type="date" value="'+cells[j]+'" />');
                                            } else {
                                                cell.html('<span id="invoice-'+i+'-'+j+'">'+cells[j]+'</span>');
                                            }
                                        } else {
                                            cell.html(cells[j]);
                                        }
                                    }
                                    row.append(cell);
                                    switch (j){
                                        case 0:{ invoice.payment_create_date = cells[j]; break; }
                                        case 1:{ invoice.payment_collect_date = cells[j]; break; }
                                        case 2:{ invoice.payment_amount = cells[j]; break; }
                                        case 3:{ invoice.interest_create_date = cells[j]; break; }
                                        case 4:{ invoice.interest_collect_date = cells[j]; break; }
                                        case 5:{ invoice.interest_amount = cells[j]; break; }
                                        case 6:{ invoice.balance = cells[j]; break; }
                                    }
                                }
                                if (i>1 && cells.length === 7)
                                    schedule.push(invoice);
                                table.append(row);
                            }
                            $dvCSV.html('');
                            $dvCSV.append(table);
                        };
                        reader.readAsText($csvUpload[0].files[0]);
                    } else {
                        return swal('This browser does not support HTML5.','','warning');
                    }
                } else {
                    return swal('Please select a valid CSV file.','','warning');
                }
            });

            $saveCSV.bind("click", function () {
                if (!schedule[0])
                    return swal('Please upload a valid CSV file.','','warning');

                validateSchedule(schedule, function (validation) {
                    if (validation.status){
                        let schedule = validation.data;
                        $csvLoader.show();
                        $.ajax({
                            'url': '/user/application/schedule/'+application_id,
                            'type': 'post',
                            'data': {schedule:schedule},
                            'success': function (data) {
                                $csvLoader.hide();
                                $csvUpload.val('');
                                swal('Schedule saved successfully','','success');
                                window.location.reload();
                            },
                            'error': function (err) {
                                $csvLoader.hide();
                                $csvUpload.val('');
                                swal('Oops! An error occurred while saving schedule','','error');
                            }
                        });
                    } else {
                        console.log(validation.data);
                        swal('There are error(s) in the uploaded schedule!','','error');
                    }
                });
            });

            let $loanSchedule = $("#loanSchedule");
            if (application.schedule && application.schedule[0]){
                let total_principal = 0,
                    table = $("<table border='1' style='text-align: center;'/>");
                for (let i = 0; i < application.schedule.length+2; i++) {
                    let row,
                        cells = [];
                    if (i <= 1){
                        row = $('<tr style="font-weight: bold;" />');
                    } else {
                        row = $("<tr />");
                        if (application.schedule[i - 2]['status'] === 2)
                            continue;
                        if (parseInt(application.schedule[i - 2]['status']) === 0)
                            row = $("<tr style='background-color: #aaaaaa; text-decoration: line-through;' />");
                    }
                    if (i === 0) {
                        cells = ["PRINCIPAL","INTEREST","BALANCE","COLLECTION"];
                    } else if (i === 1) {
                        cells = ["INVOICE DATE","COLLECTION DATE","AMOUNT","INVOICE DATE","COLLECTION DATE","AMOUNT","AMOUNT","STATUS","ACTION"];
                    } else {
                        cells[0] = application.schedule[i - 2]['payment_create_date'];
                        cells[1] = application.schedule[i - 2]['payment_collect_date'];
                        cells[2] = application.schedule[i - 2]['payment_amount'];
                        cells[3] = application.schedule[i - 2]['interest_create_date'];
                        cells[4] = application.schedule[i - 2]['interest_collect_date'];
                        cells[5] = application.schedule[i - 2]['interest_amount'];
                        cells[6] = application.schedule[i - 2]['balance'];
                        cells[7] = cells[8] = application.schedule[i - 2]['payment_status'];
                        let amount_paid = 0,
                            interest_paid = 0,
                            payment_history = $.grep(application.payment_history,function(e) {return (e.invoiceID===application.schedule[i - 2]['ID'] && e.status===1)});
                        for (let k = 0; k < payment_history.length; k++){
                            amount_paid += parseFloat(payment_history[k]['payment_amount']);
                            interest_paid += parseFloat(payment_history[k]['interest_amount']);
                        }
                        let amount_owed = parseFloat(cells[2]) - amount_paid;
                        let interest_owed = parseFloat(cells[5]) - interest_paid;
                        if (amount_paid <= 0 && interest_paid <= 0){
                            cells[7] = 0;
                        } else if (amount_owed <= 0 && interest_owed <= 0){
                            cells[7] = 1;
                        } else if ((amount_paid + interest_paid).round(2) > 0 && (amount_owed + interest_owed).round(2) > 0){
                            cells[7] = 2;
                        }
                        if (application.schedule[i - 2]['payment_status'] === 2)
                            cells[7] = 1;
                        if (application.schedule[i - 2]['status'] && cells[2])
                            total_principal += parseFloat(cells[2]);
                    }
                    for (let j = 0; j < cells.length; j++) {
                        let cell = $("<td />");
                        if (i === 0){
                            if ((cells[j] === "PRINCIPAL") || cells[j] === "INTEREST")
                                cell = $("<td colspan='3' />");
                            if (cells[j] === "COLLECTION")
                                cell = $("<td colspan='2' />");
                        }
                        if (j === cells.length-1 && i>1){
                            cell.html('<div class="btn-group">\n' +
                                '    <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                                '        <i class="fa fa-list"></i>\n' +
                                '    </button>\n' +
                                '    <div class="dropdown-menu">\n' +
                                '        <a class="dropdown-item" data-toggle="modal" data-target="#invoiceHistory" href="#" onclick="invoiceHistory('+application.schedule[i - 2]['ID']+')">Payment History</a>\n' +
                                '        <a class="dropdown-item" data-toggle="modal" data-target="#editHistory" href="#" onclick="editHistory('+application.schedule[i - 2]['ID']+')">Edit History</a>\n' +
                                '    </div>\n' +
                                '</div>');
                        } else if (j === cells.length-2 && i>1){
                            switch (cells[j]){
                                case 0: {
                                    cell.html('<span class="badge badge-danger">Not Paid</span>');
                                    break;
                                }
                                case 1: {
                                    cell.html('<span class="badge badge-success">Paid</span>');
                                    break;
                                }
                                case 2: {
                                    cell.html('<span class="badge badge-warning">Part Paid</span>');
                                    break;
                                }
                            }
                        } else {
                            if (cells[j]){
                                cell.html(cells[j]);
                            } else {
                                cell.html('--');
                            }
                        }
                        row.append(cell);
                    }
                    table.append(row);
                }
                $loanSchedule.html('');
                $loanSchedule.append(table);
                initLoanSummary(total_principal);
            }
        }

        function invoiceHistory(invoice_id) {
            $.ajax({
                'url': '/user/application/invoice-history/'+invoice_id,
                'type': 'get',
                'success': function (data) {
                    $("#invoice-history").dataTable().fnClearTable();
                    $.each(data.response, function(k, v){
                        let table = [
                            v.ID,
                            v.payment_amount,
                            v.interest_amount,
                            v.fees_amount,
                            v.penalty_amount,
                            v.agent,
                            v.date_created
                        ];
                        if (v.status === 0){
                            table.push('Payment Reversed');
                        } else if (v.status === 1){
                            table.push('<button class="btn btn-danger" onclick="reversePayment('+v.ID+','+v.invoiceID+')"><i class="fa fa-remove"></i> Reverse</button>');
                        }
                        $('#invoice-history').dataTable().fnAddData(table);
                        $('#invoice-history').dataTable().fnSort([[0,'desc']]);
                    });
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }

        function editHistory(invoice_id) {
            $.ajax({
                'url': '/user/application/edit-schedule-history/'+invoice_id,
                'type': 'get',
                'success': function (data) {
                    $("#edit-history").dataTable().fnClearTable();
                    $.each(data.response, function(k, v){
                        let table = [
                            v.payment_amount,
                            v.interest_amount,
                            v.fees_amount,
                            v.penalty_amount,
                            v.payment_collect_date,
                            v.modified_by,
                            v.date_modified
                        ];
                        $('#edit-history').dataTable().fnAddData(table);
                        $('#edit-history').dataTable().fnSort([[6,'desc']]);
                    });
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }

        let total_due_amount;
        function initLoanSummary(total_prinicipal) {
            let total_principal = total_prinicipal;
            $('#loan-amount-text').text('₦'+(parseFloat(application.loan_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
            $('#principal-total-text').text('Disbursed Amount: ₦'+total_principal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
            if (!application.payment_history || !application.payment_history[0]){
                total_due_amount = total_prinicipal;
                $('#total-due-text').text('₦'+total_principal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                $('#last-payment-text').text('N/A');
            } else {
                let count = 0,
                    payment_history = [],
                    amount = total_principal,
                    invoices = $.grep(application.schedule,function(e){return e.status===1});
                for (let i=0; i<invoices.length; i++){
                    let payments = $.grep(application.payment_history,function(e){return e.invoiceID===invoices[i]['ID']});
                    payment_history = payment_history.concat(payments);
                }
                if (payment_history[0]){
                    payment_history.forEach(function (payment) {
                        count++;
                        amount = (amount - parseFloat(payment.payment_amount)).round(2);
                        if (count === payment_history.length){
                            total_due_amount = amount;
                            $('#total-due-text').text('₦'+amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                        }
                    });
                    $('#last-payment-text').text(((payment_history[0]['date_created']).split(' '))[0]);
                } else {
                    $('#total-due-text').text('₦'+amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                    $('#last-payment-text').text('N/A');
                }
            }
            let next_payment_date = $.grep(application.schedule,function(e){return (e.payment_status===0 && e.status===1)});
            if (next_payment_date && next_payment_date[0]){
                $('#next-payment-date-text').text(next_payment_date[0]['payment_collect_date']);
            } else {
                $('#next-payment-date-text').text('N/A');
            }
        }

        function checkTotalDue() {
            if (total_due_amount === 0){
                $('#close_loan').hide();
                $('#loan_closed').show();
                $('#collect-payment-button').text('View Collection');
                $('#collect-payment-button').addClass('btn-secondary');
                $('#collect-payment-button').removeClass('btn-primary');
                $('#generate-schedule-v2').hide();
                $('#loan_closed').html('<strong>CLOSED</strong>');
                if (application.close_status === 0){
                    swal({
                        title: "Would you like to close this loan?",
                        text: "All repayments for this loan application has been made",
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                    })
                        .then((yes) => {
                            if (yes) {
                                $.ajax({
                                    'url': '/user/application/close/'+application_id,
                                    'type': 'post',
                                    'data': {close_comment:'closed'},
                                    'success': function (data) {
                                        swal('Loan closed successfully','','success');
                                        window.location.reload();
                                    },
                                    'error': function (err) {
                                        swal('Oops! An error occurred while closing loan','','error');
                                    }
                                });
                            }
                        });
                }
            }
        }

        function disburse() {
            let disbursal = {};
            disbursal.funding_source = $('#funding').val();
            disbursal.disbursement_channel = $('#channel').val();
            disbursal.disbursement_date = $('#disbursement-date').val();
            if (disbursal.funding_source === "-- Select a Funding Source --" || disbursal.disbursement_channel === "-- Select a Channel --" || !disbursal.disbursement_date)
                return swal('Kindly fill all required fields!','','warning');

            $.ajax({
                'url': '/user/application/disburse/'+application_id,
                'type': 'post',
                'data': disbursal,
                'success': function (data) {
                    swal('Loan disbursed successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while disbursing loan','','error');
                }
            });
        }

        function initCSVUpload2(application) {
            let schedule = [],
                loan_amount = 0,
                $dvCSV = $("#dvCSV2"),
                $saveCSV = $("#saveCSV2"),
                $csvUpload = $("#csvUpload2"),
                $uploadCSV = $("#uploadCSV2"),
                $csvLoader = $("#csvLoader2"),
                $rejectCSV = $("#rejectCSV2"),
                $approveCSV = $("#approveCSV2");

            $uploadCSV.bind("click", function () {
                schedule = [];
                loan_amount = 0;
                let regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
                if (regex.test($csvUpload.val().toLowerCase())) {
                    if (typeof (FileReader) !== "undefined") {
                        let reader = new FileReader();
                        reader.onload = function (e) {
                            let table = $("<table border='1' style='text-align: center;'/>"),
                                rows = e.target.result.split("\n");
                            for (let i = 0; i < rows.length; i++) {
                                let invoice = {},
                                    row = $("<tr />"),
                                    cells = rows[i].split(",");
                                if (i === 0) {
                                    cells = ["PRINCIPAL","INTEREST","BALANCE"];
                                } else if (i === 1) {
                                    cells = ["INVOICE DATE","COLLECTION DATE","AMOUNT","INVOICE DATE","COLLECTION DATE","AMOUNT","AMOUNT"];
                                }
                                for (let j = 0; j < cells.length; j++) {
                                    let cell = $("<td />");
                                    if (i === 0){
                                        if ((cells[j] === "PRINCIPAL") || cells[j] === "INTEREST")
                                            cell = $("<td colspan='3' />");
                                    }
                                    if (cells[j]){
                                        if (i > 1){
                                            if (j === 0 || j === 1 || j === 3 || j === 4){
                                                cell.html('<input id="invoice-'+i+'-'+j+'" type="date" value="'+cells[j]+'" />');
                                            } else {
                                                cell.html('<span id="invoice-'+i+'-'+j+'">'+cells[j]+'</span>');
                                            }
                                        } else {
                                            cell.html(cells[j]);
                                        }
                                    }
                                    row.append(cell);
                                    switch (j){
                                        case 0:{ invoice.payment_create_date = cells[j]; break; }
                                        case 1:{ invoice.payment_collect_date = cells[j]; break; }
                                        case 2:{
                                            if (i > 1)
                                                loan_amount = (loan_amount + parseFloat(cells[j])).round(2);
                                            invoice.payment_amount = cells[j];
                                            break;
                                        }
                                        case 3:{ invoice.interest_create_date = cells[j]; break; }
                                        case 4:{ invoice.interest_collect_date = cells[j]; break; }
                                        case 5:{ invoice.interest_amount = cells[j]; break; }
                                        case 6:{ invoice.balance = cells[j]; break; }
                                    }
                                }
                                if (i>1 && cells.length === 7)
                                    schedule.push(invoice);
                                table.append(row);
                            }
                            $dvCSV.html('');
                            $dvCSV.append(table);
                        };
                        reader.readAsText($csvUpload[0].files[0]);
                    } else {
                        return swal('This browser does not support HTML5.','','warning');
                    }
                } else {
                    return swal('Please select a valid CSV file.','','warning');
                }
            });

            $saveCSV.bind("click", function () {
                if (!schedule[0])
                    return swal('Please preview the schedule to be uploaded.','','warning');

                validateSchedule(schedule, function (validation) {
                    if (validation.status){
                        if (loan_amount.round(2) < total_due_amount.round(2))
                            return swal('Total principal on the new schedule must be greater than Principal balance','','warning');

                        let schedule = validation.data;
                        $csvLoader.show();
                        $.ajax({
                            'url': '/user/application/add-schedule/'+application_id,
                            'type': 'post',
                            'data': {schedule:schedule},
                            'success': function (data) {
                                $csvLoader.hide();
                                $csvUpload.val('');
                                swal('Reschedule added successfully','','success');
                                window.location.reload();
                            },
                            'error': function (err) {
                                $csvLoader.hide();
                                $csvUpload.val('');
                                swal('Oops! An error occurred while adding reschedule','','error');
                            }
                        });
                    } else {
                        console.log(validation.data);
                        swal('There are error(s) in the uploaded schedule!','','warning');
                    }
                });
            });

            let total_new_schedule = 0,
                new_reschedule = $.grep(application.schedule,function(e){return e.status===2});
            if (new_reschedule && new_reschedule[0]){
                let table = $("<table border='1' style='text-align: center;'/>");
                for (let i = 0; i < new_reschedule.length+2; i++) {
                    let row,
                        cells = [];
                    if (i <= 1){
                        row = $('<tr style="font-weight: bold;" />');
                    } else {
                        row = $("<tr />");
                    }
                    if (i === 0) {
                        cells = ["PRINCIPAL","INTEREST","BALANCE"];
                    } else if (i === 1) {
                        cells = ["INVOICE DATE","COLLECTION DATE","AMOUNT","INVOICE DATE","COLLECTION DATE","AMOUNT","AMOUNT"];
                    } else {
                        cells[0] = new_reschedule[i - 2]['payment_create_date'];
                        cells[1] = new_reschedule[i - 2]['payment_collect_date'];
                        cells[2] = new_reschedule[i - 2]['payment_amount'];
                        cells[3] = new_reschedule[i - 2]['interest_create_date'];
                        cells[4] = new_reschedule[i - 2]['interest_collect_date'];
                        cells[5] = new_reschedule[i - 2]['interest_amount'];
                        cells[6] = new_reschedule[i - 2]['balance'];
                    }
                    for (let j = 0; j < cells.length; j++) {
                        let cell = $("<td />");
                        if (i === 0){
                            if ((cells[j] === "PRINCIPAL") || cells[j] === "INTEREST")
                                cell = $("<td colspan='3' />");
                        }
                        if (cells[j]){
                            cell.html(cells[j]);
                        } else {
                            cell.html('--');
                        }
                        if (j === 2){
                            if (i > 1)
                                total_new_schedule = (total_new_schedule + parseFloat(cells[j])).round(2);
                        }
                        row.append(cell);
                    }
                    table.append(row);
                }
                $dvCSV.html('');
                $dvCSV.append(table);
                $('#reschedule-total-text').text('Disbursed Amount: ₦'+total_new_schedule.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
            }

            $approveCSV.bind("click", function () {
                if (!new_reschedule || !new_reschedule[0])
                    return swal('There is no reschedule available for approval!','','error');

                swal({
                    title: "Are you sure?",
                    text: "Once started, this process is not reversible!",
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                })
                    .then((yes) => {
                        if (yes) {
                            $csvLoader.show();
                            let reschedule_amount = (total_new_schedule-total_due_amount).round(2),
                                loan_amount_update = (parseFloat(application.loan_amount)+reschedule_amount).round(2);
                            $.ajax({
                                'url': '/user/application/approve-schedule/'+application_id,
                                'type': 'post',
                                'data': {reschedule_amount:reschedule_amount,loan_amount_update:loan_amount_update},
                                'success': function (data) {
                                    $csvLoader.hide();
                                    swal('Reschedule approved successfully','','success');
                                    window.location.reload();
                                },
                                'error': function (err) {
                                    $csvLoader.hide();
                                    swal('Oops! An error occurred while approving reschedule','','error');
                                }
                            });
                        }
                    });
            });

            $rejectCSV.bind("click", function () {
                if (!new_reschedule || !new_reschedule[0])
                    return swal('There is no reschedule available to delete!','','error');

                $csvLoader.show();
                $.ajax({
                    'url': '/user/application/reject-schedule/'+application_id,
                    'type': 'get',
                    'success': function (data) {
                        $csvLoader.hide();
                        swal('Reschedule deleted successfully','','success');
                        window.location.reload();
                    },
                    'error': function (err) {
                        $csvLoader.hide();
                        swal('Oops! An error occurred while deleting reschedule','','error');
                    }
                });
            });
        }

        function validateSchedule(schedule, callback) {
            let errors = [],
                validated_schedule = [];
            for (let i=0; i<schedule.length; i++){
                let invoice = {},
                    $col0 = $('#invoice-'+(i+2)+'-0'),
                    $col1 = $('#invoice-'+(i+2)+'-1'),
                    $col2 = $('#invoice-'+(i+2)+'-2'),
                    $col3 = $('#invoice-'+(i+2)+'-3'),
                    $col4 = $('#invoice-'+(i+2)+'-4'),
                    $col5 = $('#invoice-'+(i+2)+'-5'),
                    $col6 = $('#invoice-'+(i+2)+'-6'),
                    a = $col0.val(),
                    b = $col1.val(),
                    c = schedule[i]['payment_amount'],
                    d = $col3.val(),
                    e = $col4.val(),
                    f = schedule[i]['interest_amount'],
                    g = schedule[i]['balance'];
                if (isValidDate(a)){
                    $col0.removeClass('invalid');
                    invoice.payment_create_date = a;
                } else {
                    $col0.addClass('invalid');
                    errors.push(a+' is not a valid date');
                }
                if (isValidDate(b)){
                    $col1.removeClass('invalid');
                    invoice.payment_collect_date = b;
                } else {
                    $col1.addClass('invalid');
                    errors.push(b+' is not a valid date');
                }
                if (!isNaN(c)){
                    $col2.removeClass('invalid');
                    invoice.payment_amount = c;
                } else {
                    $col2.addClass('invalid');
                    errors.push(c+' is not a valid number');
                }
                if (isValidDate(d)){
                    $col3.removeClass('invalid');
                    invoice.interest_create_date = d;
                } else {
                    $col3.addClass('invalid');
                    errors.push(d+' is not a valid date');
                }
                if (isValidDate(e)){
                    $col4.removeClass('invalid');
                    invoice.interest_collect_date = e;
                } else {
                    $col4.addClass('invalid');
                    errors.push(e+' is not a valid date');
                }
                if (!isNaN(f)){
                    $col5.removeClass('invalid');
                    invoice.interest_amount = f;
                } else {
                    $col5.addClass('invalid');
                    errors.push(f+' is not a valid number');
                }
                if (!isNaN(g)){
                    $col6.removeClass('invalid');
                    invoice.balance = g;
                } else {
                    $col6.addClass('invalid');
                    errors.push(g+' is not a valid number');
                }
                validated_schedule.push(invoice);
                console.log(a)
                console.log(b)
                console.log(c)
                console.log(d)
                console.log(e)
                console.log(f)
                console.log(g)
            }
            if (errors[0]){
                callback({status: false, data: errors});
            } else {
                callback({status: true, data: validated_schedule});
            }
        }

        function isValidDate(dateString) {
            let regEx = /^\d{4}-\d{2}-\d{2}$/;
            if(!dateString || !dateString.match(regEx)) return false;
            let d = new Date(dateString);
            if(Number.isNaN(d.getTime())) return false;
            return d.toISOString().slice(0,10) === dateString;
        }

        function openPayOffModal() {
            $('#payoff-amount').val($('#total-due-text').text());
            let interest = 0;
            let invoices = $.grep(application.schedule,function (e) {return (parseInt(e.status)===1 && parseInt(e.payment_status)===0)});
            if (invoices && invoices[0]){
                invoices.forEach(function (invoice) {
                    interest += parseFloat(invoice.interest_amount);
                    $('#payoff-interest').val(interest);
                });
            } else {
                $('#payoff-interest').val(0);
            }
        }

        function openWriteOffModal() {
            $('#writeoff-name').val(application.fullname);
            $('#writeoff-amount').val($('#total-due-text').text());
        }

        function writeOffLoan() {
            $.ajax({
                'url': '/user/application/write-off/'+application_id,
                'type': 'post',
                'data': {close_comment:$('#writeoff-notes').val()},
                'success': function (data) {
                    swal('Loan closed successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while closing loan','','error');
                }
            });
        }

        function payOffLoan() {
            let payoff = {};
            payoff.close_interest = $('#payoff-interest').val();
            payoff.close_date = $('#payoff-date').val();
            payoff.close_channel = $('#payoff-channel').val();
            payoff.close_comment = $('#payoff-notes').val();
            if ($('input[name=payoff-include-interest]:checked').val())
                payoff.close_include_interest = $('input[name=payoff-include-interest]:checked').val();
            if (!payoff.close_interest || !payoff.close_date || !payoff.close_channel)
                return swal('Kindly fill all required inputs to close loan','','warning');
            $.ajax({
                'url': '/user/application/pay-off/'+application_id,
                'type': 'post',
                'data': payoff,
                'success': function (data) {
                    swal('Loan closed successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while closing loan','','error');
                }
            });
        }

        function saveLoanCirrusID() {
            let id = $('#loancirrus-id-input').val();
            if (!id)
                return swal('Kindly input loan cirrus id','','warning');
            $.ajax({
                'url': '/user/application/loancirrus-id/'+application_id,
                'type': 'post',
                'data': {id:id},
                'success': function (data) {
                    swal('Loan cirrus id updated successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while updating loan cirrus id','','error');
                }
            });
        }

        function read_write(){
            let w;
            var perms = JSON.parse(localStorage.getItem("permissions"));
            var page = (window.location.pathname.split('/')[1].split('.'))[0];
            perms.forEach(function (k,v){
                if (k.module_name === page){
                    w = $.grep(perms, function(e){return e.id === parseInt(k.id);});
                }
            });
            if (w && w[0] && (parseInt(w[0]['editable']) != 1)){
                $(".write").hide();
            }
        }

        Number.prototype.roundTo = function(n) {
            return Math.ceil(this/n)*n;
        };

        Number.prototype.round = function(p) {
            p = p || 10;
            return parseFloat( this.toFixed(p) );
        };

        function padWithZeroes(n, width, z) {
            z = z || '0';
            n = n + '';
            return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }
    </script>
</body>
</html>

<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Loanratus Admin</title>
    <meta name="description" content="Loanratus Admin">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="apple-icon.png">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/themify-icons.css">
    <link rel="stylesheet" href="assets/css/flag-icon.min.css">
    <link rel="stylesheet" href="assets/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="assets/css/lib/datatable/dataTables.bootstrap.min.css">
    <!-- <link rel="stylesheet" href="assets/css/bootstrap-select.less"> -->
    <link rel="stylesheet" href="assets/scss/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/html5shiv/3.7.3/html5shiv.min.js"></script> -->
    <!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
    <link rel="stylesheet" href="css/jquery.fileupload.css">
    <link rel="stylesheet" href="css/jquery.fileupload-ui.css">
    <!-- CSS adjustments for browsers with JavaScript disabled -->
    <noscript><link rel="stylesheet" href="css/jquery.fileupload-noscript.css"></noscript>
    <noscript><link rel="stylesheet" href="css/jquery.fileupload-ui-noscript.css"></noscript>
    <style type="text/css">
        ul.nav li.active p{color: #ffffff;}
        a, a p, a h4, a:hover{color: rgb(66, 139, 202);}
        li.disabled a p, li.disabled a h4 {color: #878787;}
        li.active a h4 {color: #ffffff;}
        table{width: 100%;}
        table th{text-align: center;}
        .modal-dialog{
            left: 0;
        }
        .thumbnail {
            padding:0px;
        }
        .panel {
            position:relative;
        }
        .panel>.panel-heading:after,.panel>.panel-heading:before{
            position:absolute;
            top:11px;left:-16px;
            right:100%;
            width:0;
            height:0;
            display:block;
            content:" ";
            border-color:transparent;
            border-style:solid solid outset;
            pointer-events:none;
        }
        .panel>.panel-heading:after{
            border-width:7px;
            border-right-color:#f7f7f7;
            margin-top:1px;
            margin-left:2px;
        }
        .panel>.panel-heading:before{
            border-right-color:#ddd;
            border-width:8px;
        }
        select.form-control{
            height: 36px !important;
        }
        #loanCollectionSchedule table tr:nth-child(2){
            font-size: 14px;
        }
        #loanCollectionSchedule table tr td{
            padding: 5px;
            white-space: nowrap;
        }
        #loanCollectionSchedule table tr:nth-child(1) td, table tr:nth-child(2) td{
            padding: 10px;
        }
        .badge-success {
            background-color: #28a745;
        }
        .badge-danger {
            background-color: #dc3545;
        }
        .badge-warning {
            background-color: #f0ad4e;
        }
        #message{
            font-weight: bold;
            font-style: italic;
        }
        #message.success{
            color: #28a745;
        }
        #message.error{
            color: #dc3545;
        }
        input.error {
            border-color: #dc3545;
        }
    </style>
</head>
<body class="open">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f" crossorigin="anonymous"></script>
<!-- Left Panel -->
    <script type="text/javascript">
        jQuery(document).ready(function($){ check(); loadMenus();});
    </script>

<aside id="left-panel" class="left-panel">
    <nav class="navbar navbar-expand-sm navbar-default">

        <div class="navbar-header">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-menu" aria-controls="main-menu" aria-expanded="false" aria-label="Toggle navigation">
                <i class="fa fa-bars"></i>
            </button>
            <a class="navbar-brand" href="/dashboard">Loanratus</a>
            <a class="navbar-brand hidden" href="/dashboard">35</a>
        </div>

        <div id="main-menu" class="main-menu collapse navbar-collapse">
            <ul id="sidebar" class="nav navbar-nav">
            </ul>
        </div><!-- /.navbar-collapse -->
    </nav>
</aside><!-- /#left-panel -->
    <!-- Left Panel -->

    <!-- Right Panel -->
    <div id="right-panel" class="right-panel">
        <!-- Header-->
        <header id="header" class="header">

            <div class="header-menu">

                <div class="col-sm-7">
                    <a id="menuToggle" class="menutoggle pull-left"><i class="fa fa fa-tasks"></i></a>
                    <div class="header-left">
                        <button class="search-trigger"><i class="fa fa-search"></i></button>
                        <div class="form-inline">
                            <form class="search-form">
                                <input class="form-control mr-sm-2" type="text" placeholder="Search ..." aria-label="Search">
                                <button class="search-close" type="submit"><i class="fa fa-close"></i></button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-sm-5">
                    <div class="user-area dropdown float-right">
                        <strong id="user" style="margin-right:10px; vertical-align: sub"></strong>
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img class="user-avatar rounded-circle" src="images/admin.jpg" alt="User Avatar">
                        </a>

                        <div class="user-menu dropdown-menu">
                                <!-- <a class="nav-link" href="#"><i class="fa fa- user"></i>My Profile</a>

                                <a class="nav-link" href="#"><i class="fa fa- user"></i>Notifications <span class="count">13</span></a>

                                <a class="nav-link" href="#"><i class="fa fa -cog"></i>Settings</a> -->

                            <a class="nav-link pull-right" href="#" onclick="logout()"><i class="fa fa-power-off"></i> Logout</a>
                            <script type="text/javascript">
                                function logout() {
                                    localStorage.login = "0";
                                    window.location.href = "/logout";
                                }
                            </script>
                        </div>
                    </div>

                </div>
            </div>

        </header><!-- /header -->
        <!-- Header-->

        <div class="breadcrumbs">
            <div class="col-sm-4">
                <div class="page-header float-left">
                    <div class="page-title">
                        <h1>Loan Repayment</h1>
                    </div>
                </div>
            </div>
            <div class="col-sm-8">
                <div class="page-header float-right">
                    <div class="page-title">
                        <ol class="breadcrumb text-right">
                            <li><a href="#">Dashboard</a></li>
                            <li><a href="#">Users</a></li>
                            <li class="active"><a href="/all-applications">All Applications</a></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <div class="content mt-3">
            <div class="animated fadeIn">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <div style="float: left; margin: 0 15px;">
                                    <strong id="workflow-div-title" class="card-title">Workflow</strong>
                                    <p>Client ID#: <a onclick="goToClientProfile()" style="text-decoration: underline; cursor: pointer;"><span id="client-id"></span></a> | LOAN ID#: <span id="application-id"></span></p>
                                </div>
                                <button class="btn btn-primary" onclick="goToLoanOverview()" style="float: right;">Loan Overview <i class="fa fa-forward"></i></button>
                                <button class="btn btn-success" data-toggle="modal" data-target="#addPaymentModal" style="float: right;">Add Additional Interest</button>
                                <a href="#" style="float: right; margin: 8px; text-decoration: underline;" data-toggle="modal" data-target="#escrowHistory" onclick="escrowHistory()">Escrow Balance: ₦<span class="escrow-balance">0</span></a>
                            </div>
                            <div class="card-body">
                                <div id="loanCollectionSchedule" style="margin-top: 30px; overflow-x: scroll; max-width: 1200px"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <span style="margin: 5px;">Comments</span>
                                <button class ="btn btn-info" style="float: right;" data-toggle="modal" data-target="#addCommentModal">Add Comment <i class="fa fa-comment"></i></button>
                            </div>
                            <div class="card-body">
                                <div id="comments"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- .animated -->
        <div id="wait" style=";width:150px;height:100px;position:fixed;top:50%;left:50%;padding:2px;"><img src='spinner.gif' width="100" height="100" style="background-color: transparent"/></div>
    </div><!-- .content -->
<!-- Right Panel -->

    <!-- Modal -->
    <div class="modal" id="addCommentModal" tabindex="-1" role="dialog" aria-labelledby="addCommentModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addCommentModalLabel">Post Comment</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label class=" form-control-label">Comment</label><strong style="color:red"> *</strong><span id="comment-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-comment"></i></div>
                                <textarea id="comment" class="form-control" required="required" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="comment()">Comment</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmPayment" tabindex="-1" role="dialog" aria-labelledby="confirmPaymentLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="confirmPaymentLabel">Repayment</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <h4 id="overpayment-message" style="color: #f0ad4e;"></h4>
                        <span id="message"></span>
                        <div class="form-group">
                            <label class=" form-control-label">Payment Source</label><strong style="color:red"> *</strong><span id="source-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-link"></i></div>
                                <select id="source" class="form-control" required="required">
                                    <option value="0" selected="selected">-- Select Payment Source --</option>
                                    <option value="cash">Cash</option>
                                    <option value="escrow">Escrow</option>
                                </select>
                            </div>
                            <small class="form-text text-muted">Escrow Balance available is ₦<span class="escrow-balance">0</span></small>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Actual Payment</label><strong style="color:red"> *</strong><span id="payment-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="payment" type="number" class="form-control validate" placeholder="0" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Principal</label><strong style="color:red"> *</strong><span id="principal-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="principal" type="number" class="form-control validate" placeholder="0" required="required">
                            </div>
                            <small class="form-text text-muted">Maximum Principal Payable is <span id="principal-payable"></span></small>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Interest</label><strong style="color:red"> *</strong><span id="interest-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="interest" type="number" class="form-control validate" placeholder="0" required="required">
                            </div>
                            <small class="form-text text-muted">Maximum Interest Payable is <span id="interest-payable"></span></small>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Fees</label><strong style="color:red"> *</strong><span id="fees-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="fees" type="number" class="form-control" placeholder="0" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Penalty</label><strong style="color:red"> *</strong><span id="penalty-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="penalty" type="number" class="form-control" placeholder="0" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Payment date</label><strong style="color:red"> *</strong><span id="repayment-date-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input id="repayment-date" type="date" class="form-control" required="required">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="confirm-payment-button" type="button" class="btn btn-primary" onclick="confirmPayment()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="editSchedule" tabindex="-1" role="dialog" aria-labelledby="editScheduleLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="editScheduleLabel">Edit Schedule</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div id="edit-principal-invoice-div" class="form-group">
                            <label class=" form-control-label">Principal Invoice No</label><strong style="color:red"> *</strong><span id="edit-principal-invoice-no-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-sticky-note"></i></div>
                                <input id="edit-principal-invoice-no" type="text" class="form-control" placeholder="0" required="required">
                            </div>
                        </div>
                        <div id="edit-interest-invoice-div" class="form-group">
                            <label class=" form-control-label">Interest Invoice No</label><strong style="color:red"> *</strong><span id="edit-interest-invoice-no-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-sticky-note"></i></div>
                                <input id="edit-interest-invoice-no" type="text" class="form-control" placeholder="0" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Principal</label><strong style="color:red"> *</strong><span id="edit-principal-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="edit-principal" type="number" class="form-control" placeholder="0" required="required" disabled="disabled">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Interest</label><strong style="color:red"> *</strong><span id="edit-interest-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="edit-interest" type="number" class="form-control" placeholder="0" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Fees</label><strong style="color:red"> *</strong><span id="edit-fees-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="edit-fees" type="number" class="form-control" placeholder="0" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Penalty</label><strong style="color:red"> *</strong><span id="edit-penalty-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon">₦</div>
                                <input id="edit-penalty" type="number" class="form-control" placeholder="0" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Principal Payment Date</label><strong style="color:red"> *</strong><span id="edit-principal-payment-date-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input id="edit-principal-payment-date" type="date" class="form-control" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Principal Invoice Date</label><strong style="color:red"> *</strong><span id="edit-principal-invoice-date-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input id="edit-principal-invoice-date" type="date" class="form-control" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Interest Payment Date</label><strong style="color:red"> *</strong><span id="edit-interest-payment-date-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input id="edit-interest-payment-date" type="date" class="form-control" required="required">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Interest Invoice Date</label><strong style="color:red"> *</strong><span id="edit-interest-invoice-date-error" style="padding-left:50px; text-align: center"></span>
                            <div class="input-group">
                                <div class="input-group-addon"><i class="fa fa-calendar"></i></div>
                                <input id="edit-interest-invoice-date" type="date" class="form-control" required="required">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editSchedule()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="invoiceHistory" tabindex="-1" role="dialog" aria-labelledby="invoiceHistoryLabel">
        <div class="modal-dialog modal-lg" role="document" style="width: 1005%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="invoiceHistoryLabel">Repayment History</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <table id="invoice-history" class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Principal</th>
                            <th>Interest</th>
                            <th>Fees</th>
                            <th>Penalty</th>
                            <th>Paid By</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="history">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="escrowHistory" tabindex="-1" role="dialog" aria-labelledby="escrowHistoryLabel">
        <div class="modal-dialog modal-lg" role="document" style="width: 1005%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="escrowHistoryLabel">Escrow History</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <table id="escrow-history" class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>Amount</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="escrow_history">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editHistory" tabindex="-1" role="dialog" aria-labelledby="editHistoryLabel">
        <div class="modal-dialog modal-lg" role="document" style="width: 1005%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="editHistoryLabel">Edit Schedule History</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <table id="edit-history" class="table table-striped table-bordered">
                        <thead>
                        <tr>
                            <th>Previous Principal</th>
                            <th>Previous Interest</th>
                            <th>Previous Fees</th>
                            <th>Previous Penalty</th>
                            <th>Previous Date Due</th>
                            <th>Modified By</th>
                            <th>Date Modified</th>
                        </tr>
                        </thead>
                        <tbody id="e-history">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addPaymentModal" tabindex="-1" role="dialog" aria-labelledby="addPaymentModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="addPaymentModalLabel">Add Payment</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body">
                    <form>
                        <!--<div class="form-group">-->
                            <!--<label class=" form-control-label">Payment Amount</label>-->
                            <!--<div class="input-group">-->
                                <!--<input id="payment-amount" type="number" class="form-control">-->
                            <!--</div>-->
                        <!--</div>-->
                        <div class="form-group">
                            <label class=" form-control-label">Interest Amount</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <input id="payment-interest" type="number" class="form-control" value="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Payment Date</label><strong style="color:red"> *</strong>
                            <div class="input-group">
                                <input id="payment-date" type="date" class="form-control">
                            </div>
                            <small class="form-text text-muted">Note, payment date cannot be a future date</small>
                        </div>
                        <div class="form-group">
                            <label class=" form-control-label">Notes</label>
                            <div class="input-group">
                                <textarea id="payment-notes" class="form-control" maxlength="250" placeholder="Brief message"></textarea>
                            </div>
                            <small class="form-text text-muted">Maximum of 250 characters</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addPayment()">Add Payment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/popper.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/plugins.js"></script>
    <script src="assets/js/main.js"></script>


    <script src="assets/js/lib/data-table/datatables.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/dataTables.buttons.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.bootstrap.min.js"></script>
    <script src="assets/js/lib/data-table/jszip.min.js"></script>
    <script src="assets/js/lib/data-table/pdfmake.min.js"></script>
    <script src="assets/js/lib/data-table/vfs_fonts.js"></script>
    <script src="assets/js/lib/data-table/buttons.html5.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.print.min.js"></script>
    <script src="assets/js/lib/data-table/buttons.colVis.min.js"></script>
    <script src="assets/js/lib/data-table/datatables-init.js"></script>

    <!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
    <script src="js/vendor/jquery.ui.widget.js"></script>
    <!-- The Templates plugin is included to render the upload/download listings -->
    <script src="https://blueimp.github.io/JavaScript-Templates/js/tmpl.min.js"></script>
    <!-- The Load Image plugin is included for the preview images and image resizing functionality -->
    <script src="https://blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js"></script>
    <!-- The Canvas to Blob plugin is included for image resizing functionality -->
    <script src="https://blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>
    <!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
    <script src="js/jquery.iframe-transport.js"></script>
    <!-- The basic File Upload plugin -->
    <script src="js/jquery.fileupload.js"></script>
    <!-- The File Upload processing plugin -->
    <script src="js/jquery.fileupload-process.js"></script>
    <!-- The File Upload image preview & resize plugin -->
    <script src="js/jquery.fileupload-image.js"></script>
    <!-- The File Upload audio preview plugin -->
    <script src="js/jquery.fileupload-audio.js"></script>
    <!-- The File Upload video preview plugin -->
    <script src="js/jquery.fileupload-video.js"></script>
    <!-- The File Upload validation plugin -->
    <script src="js/jquery.fileupload-validate.js"></script>
    <!-- The File Upload user interface plugin -->
    <script src="js/jquery.fileupload-ui.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            loadUsers();
            loadComments();
        });

        $(document).ajaxStart(function(){
            $("#wait").css("display", "block");
        });

        $(document).ajaxComplete(function(){
            $("#wait").css("display", "none");
        });

        const urlParams = new URLSearchParams(window.location.search);
        const application_id = urlParams.get('id');

        function goToLoanOverview() {
            window.location.href = '/application?id='+application_id;
        }

        function check(){
            if (localStorage.getItem('role') !== 1){
                jQuery('#car-models').hide();
                jQuery('#new-user').hide();
                jQuery('#models-card').hide();
                jQuery('#user').html(localStorage.getItem("name"));
            }
            else{
                jQuery('#user').html(localStorage.getItem("name"));
            }
        }

        function loadMenus(){
            let modules = {};
            modules = JSON.parse(localStorage.getItem("modules"));
            modules.forEach(function(k, v){
                if (k.menu_name === 'Sub Menu'){
                    let main = $.grep(modules, function(e){return e.id === parseInt(k.main_menu);});
                    $('#'+$(main[0]['module_tag']).attr('id') + ' > .sub-menu').append(k.module_tag);
                }else if(k.menu_name === 'Main Menu'){
                    $('#sidebar').append(k.module_tag);
                    $('#'+$(k.module_tag).attr('id')).append('<ul class="sub-menu children dropdown-menu"></ul>');
                }else{
                    $('#'+k.module_name).show();
                }
            });
            $.ajax({
                type: "GET",
                url: "/user/all-requests",
                success: function (response) {
                    $.each(response, function(k,v){
                        $('#requests-badge').html(v.requests);
                    });
                }
            });
            $.ajax({
                type: "GET",
                url: "/user/all-applications",
                success: function (response) {
                    $.each(response, function(k,v){
                        $('#applications-badge').html(v.applications);
                    });
                }
            });
        }

        let application;

        function loadUsers(){
            $.ajax({
                'url': '/user/application-id/'+application_id,
                'type': 'get',
                'success': function (result) {
                    let data = result.response,
                        fullname = data.fullname || '';
                    application = data;
                    $('#client-id').text(padWithZeroes(application.userID,6));
                    $('#application-id').text(padWithZeroes(application.ID,9));
                    if (application.escrow)
                        $('.escrow-balance').text(parseFloat(application.escrow).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                    initRepaymentSchedule(application);
                    $("#workflow-div-title").text(fullname.toUpperCase());
                },
                'error': function (err) {
                    console.log('Error');
                }
            });
        }

        function goToClientProfile() {
            window.location.href = '/client-info?id='+application.userID;
        }

        function padWithZeroes(n, width, z) {
            z = z || '0';
            n = n + '';
            return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
        }

        function loadComments(comments) {
            if (comments && comments[0]){
                let $comments = $('#comments');
                $comments.html('');
                comments.forEach(function (comment) {
                    $comments.append('<div class="row">\n' +
                        '    <div class="col-sm-1">\n' +
                        '        <div class="thumbnail"><img class="img-responsive user-photo" src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png"></div>\n' +
                        '    </div>\n' +
                        '    <div class="col-sm-11">\n' +
                        '        <div class="panel panel-default">\n' +
                        '            <div class="panel-heading"><strong>'+comment.fullname+'</strong> <span class="text-muted">commented on '+comment.date_created+'</span></div>\n' +
                        '            <div class="panel-body">'+comment.text+'</div>\n' +
                        '        </div>\n' +
                        '    </div>\n' +
                        '</div>');
                });
            } else {
                $.ajax({
                    'url': '/user/application/comments/'+application_id,
                    'type': 'get',
                    'success': function (data) {
                        let comments = data.response,
                            $comments = $('#comments');
                        $comments.html('');
                        if (!comments[0])
                            return $comments.append('<h2 style="margin: auto;">No comments available yet!</h2>');
                        comments.forEach(function (comment) {
                            $comments.append('<div class="row">\n' +
                                '    <div class="col-sm-1">\n' +
                                '        <div class="thumbnail"><img class="img-responsive user-photo" src="https://ssl.gstatic.com/accounts/ui/avatar_2x.png"></div>\n' +
                                '    </div>\n' +
                                '    <div class="col-sm-11">\n' +
                                '        <div class="panel panel-default">\n' +
                                '            <div class="panel-heading"><strong>'+comment.fullname+'</strong> <span class="text-muted">commented on '+comment.date_created+'</span></div>\n' +
                                '            <div class="panel-body">'+comment.text+'</div>\n' +
                                '        </div>\n' +
                                '    </div>\n' +
                                '</div>');
                        });
                    },
                    'error': function (err) {
                        console.log('Error');
                        swal('No internet connection','','error');
                    }
                });
            }
        }

        function comment(){
            let $comment = $("#comment"),
                comment = $comment.val();
            if (!comment || comment === "")
                return swal('Kindly type a brief comment','','warning');
            $('#wait').show();
            $('#addCommentModal').modal('hide');
            $.ajax({
                'url': '/user/application/comments/'+application_id+'/'+(JSON.parse(localStorage.getItem('user_obj')))['ID'],
                'type': 'post',
                'data': {text: comment},
                'success': function (data) {
                    $('#wait').hide();
                    let comments = data.response;
                    results = comments;
                    loadComments(comments);
                    $comment.val("");
                    swal('Comment saved successfully','','success');
                },
                'error': function (err) {
                    $('#wait').hide();
                    $comment.val("");
                    swal('Oops! An error occurred while saving comment','','error');
                }
            });
        }

        function initRepaymentSchedule(application) {
            let $loanCollectionSchedule = $("#loanCollectionSchedule");
            if (application.schedule && application.schedule[0]){
                let table = $("<table border='1' style='text-align: center;'/>"),
                    total = ['TOTAL',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
                for (let i = 0; i < application.schedule.length+2; i++) {
                    let row,
                        cells = [];
                    if (i <= 1){
                        row = $('<tr style="font-weight: bold;" />');
                    } else {
                        row = $("<tr />");
                        if (application.schedule[i - 2]['status'] === 2)
                            continue;
                        if (parseInt(application.schedule[i - 2]['status']) === 0)
                            row = $("<tr style='background-color: #aaaaaa; text-decoration: line-through;' />");
                    }
                    if (i === 0) {
                        cells = ["","","","SCHEDULED PAYMENTS","ACTUAL PAYMENTS","AMOUNT DUE"];
                    } else if (i === 1) {
                        cells = ["DUE","STATUS","ACTION","PRINCIPAL","INTEREST","FEES","PENALTY","TOTAL","PRINCIPAL","INTEREST","FEES","PENALTY","TOTAL","PRINCIPAL","INTEREST","FEES","PENALTY","TOTAL"];
                    } else {
                        application.schedule[i - 2]['actual_fees_amount'] = application.schedule[i - 2]['actual_fees_amount'] || "0";
                        application.schedule[i - 2]['actual_interest_amount'] = application.schedule[i - 2]['actual_interest_amount'] || "0";
                        application.schedule[i - 2]['actual_payment_amount'] = application.schedule[i - 2]['actual_payment_amount'] || "0";
                        application.schedule[i - 2]['actual_penalty_amount'] = application.schedule[i - 2]['actual_penalty_amount'] || "0";
                        application.schedule[i - 2]['applicationID'] = application.schedule[i - 2]['applicationID'] || "0";
                        application.schedule[i - 2]['balance'] = application.schedule[i - 2]['balance'] || "0";
                        application.schedule[i - 2]['fees_amount'] = application.schedule[i - 2]['fees_amount'] || "0";
                        application.schedule[i - 2]['interest_amount'] = application.schedule[i - 2]['interest_amount'] || "0";
                        application.schedule[i - 2]['payment_amount'] = application.schedule[i - 2]['payment_amount'] || "0";
                        application.schedule[i - 2]['penalty_amount'] = application.schedule[i - 2]['penalty_amount'] || "0";
                        cells[0] = application.schedule[i - 2]['payment_collect_date'];
                        cells[1] = cells[2] = application.schedule[i - 2]['payment_status'];
                        cells[3] = application.schedule[i - 2]['payment_amount'];
                        cells[4] = application.schedule[i - 2]['interest_amount'];
                        cells[5] = application.schedule[i - 2]['fees_amount'];
                        cells[6] = application.schedule[i - 2]['penalty_amount'];
                        cells[7] = totalPayment(application.schedule[i - 2]);
                        let payment_history = $.grep(application.payment_history,function(e) {return (e.invoiceID===application.schedule[i - 2]['ID'] && e.status===1)});
                        cells[8] = 0;
                        cells[9] = 0;
                        cells[10] = 0;
                        cells[11] = 0;
                        for (let k = 0; k < payment_history.length; k++){
                            cells[8] += parseFloat(payment_history[k]['payment_amount']);
                            cells[9] += parseFloat(payment_history[k]['interest_amount']);
                            cells[10] += parseFloat(payment_history[k]['fees_amount']);
                            cells[11] += parseFloat(payment_history[k]['penalty_amount']);
                        }
                        cells[8] = (cells[8]).toString();
                        cells[9] = (cells[9]).toString();
                        cells[10] = (cells[10]).toString();
                        cells[11] = (cells[11]).toString();
                        cells[12] = totalActualPayment({actual_payment_amount:cells[8],actual_interest_amount:cells[9],actual_fees_amount:cells[10],actual_penalty_amount:cells[11]});
                        cells[13] = ((parseFloat(cells[3])-parseFloat(cells[8])).round(2)).toString();
                        cells[14] = ((parseFloat(cells[4])-parseFloat(cells[9])).round(2)).toString();
                        cells[15] = (parseFloat(cells[5])-parseFloat(cells[10]) > 0)?((parseFloat(cells[5])-parseFloat(cells[10])).round(2)).toString():'0';
                        cells[16] = (parseFloat(cells[6])-parseFloat(cells[11]) > 0)?((parseFloat(cells[6])-parseFloat(cells[11])).round(2)).toString():'0';
                        cells[17] = ((parseFloat(cells[13])+parseFloat(cells[14])+parseFloat(cells[15])+parseFloat(cells[16])).round(2)).toString();
                        if ((parseFloat(cells[8]) <= 0) && (parseFloat(cells[9]) <= 0)){
                            cells[1] = cells[2] = 0;
                        } else if ((parseFloat(cells[13]) <= 0) && (parseFloat(cells[14]) <= 0)){
                            cells[1] = cells[2] = 1;
                        } else if ((parseFloat(cells[8]) + parseFloat(cells[9])).round(2) > 0 && (parseFloat(cells[13]) + parseFloat(cells[14])).round(2) > 0) {
                            cells[1] = cells[2] = 2;
                        }
                        if (application.schedule[i - 2]['payment_status'] === 2)
                            cells[1] = cells[2] = 1;
                        if (application.schedule[i - 2]['status'] === 1){
                            total[3] += parseFloat(cells[3]);
                            total[4] += parseFloat(cells[4]);
                            total[5] += parseFloat(cells[5]);
                            total[6] += parseFloat(cells[6]);
                            total[7] += parseFloat(cells[7]);
                            total[8] += parseFloat(cells[8]);
                            total[9] += parseFloat(cells[9]);
                            total[10] += parseFloat(cells[10]);
                            total[11] += parseFloat(cells[11]);
                            total[12] += parseFloat(cells[12]);
                            total[13] += parseFloat(cells[13]);
                            total[14] += parseFloat(cells[14]);
                            total[15] += parseFloat(cells[15]);
                            total[16] += parseFloat(cells[16]);
                            total[17] += parseFloat(cells[17]);
                        }
                    }
                    let interest_invoice_no = (i > 0 && application.schedule[i - 2])? application.schedule[i - 2]['interest_invoice_no'] : '',
                        principal_invoice_no = (i > 0 && application.schedule[i - 2])? application.schedule[i - 2]['principal_invoice_no'] : '';
                    cells.push(principal_invoice_no);
                    cells.push(interest_invoice_no);
                    for (let j = -2; j < cells.length-2; j++) {
                        let cell = $("<td />");
                        if (i === 0){
                            if (j === -2){
                                cell = $("<td colspan='2' />");
                                cell.html('INVOICE NO');
                            } else if (j === -1){
                                cell = '';
                            } else {
                                cells[j] = cells[j] || "";
                                if (cells[j] !== ""){
                                    cell = $("<td colspan='5' />");
                                    cell.html(cells[j]);
                                }
                            }
                        } else if (i === 1){
                            if (j === -2){
                                cell.html('PRINCIPAL');
                            } else if (j === -1){
                                cell.html('INTEREST');
                            } else {
                                cell.html(cells[j]);
                            }
                        } else {
                            if (j === -2 && i>1){
                                cell.html(cells[18] || 'N/A');
                            } else if (j === -1 && i>1){
                                cell.html(cells[19] || 'N/A');
                            } else if (j === 0 && i>1){
                                cell.html(cells[j]);
                            } else if (j === 1 && i>1){
                                switch (cells[j]){
                                    case 0: {
                                        cell.html('<span class="badge badge-danger">Not Paid</span>');
                                        break;
                                    }
                                    case 1: {
                                        cell.html('<span class="badge badge-success">Paid</span>');
                                        break;
                                    }
                                    case 2: {
                                        cell.html('<span class="badge badge-warning">Part Paid</span>');
                                        break;
                                    }
                                }
                            } else if (j === 2 && i>1) {
                                if ((parseInt(application.schedule[i - 2]['status']) !== 0) && (parseInt(cells[j]) !== 1)){
                                    if (parseInt(cells[j]) === 0){
                                        cell.html('<div class="btn-group">\n' +
                                            '    <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                                            '        <i class="fa fa-list"></i>\n' +
                                            '    </button>\n' +
                                            '    <div class="dropdown-menu">\n' +
                                            '        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#confirmPayment" onclick="confirmPaymentModal('+application.schedule[i - 2]['ID']+')">Confirm Payment</a>\n' +
                                            '        <div class="dropdown-divider"></div>\n' +
                                            '        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#editSchedule" onclick="editScheduleModal('+application.schedule[i - 2]['ID']+')">Edit Schedule</a>\n' +
                                            '        <a class="dropdown-item" data-toggle="modal" data-target="#invoiceHistory" href="#" onclick="invoiceHistory('+application.schedule[i - 2]['ID']+')">Payment History</a>\n' +
                                            '        <a class="dropdown-item" data-toggle="modal" data-target="#editHistory" href="#" onclick="editHistory('+application.schedule[i - 2]['ID']+')">Edit History</a>\n' +
                                            '        <a class="dropdown-item" href="#" onclick="writeOff('+application.schedule[i - 2]['ID']+')">Write Off</a>\n' +
                                            '    </div>\n' +
                                            '</div>');
                                    } else {
                                        cell.html('<div class="btn-group">\n' +
                                            '    <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                                            '        <i class="fa fa-list"></i>\n' +
                                            '    </button>\n' +
                                            '    <div class="dropdown-menu">\n' +
                                            '        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#confirmPayment" onclick="confirmPaymentModal('+application.schedule[i - 2]['ID']+')">Confirm Payment</a>\n' +
                                            '        <div class="dropdown-divider"></div>\n' +
                                            '        <a class="dropdown-item" data-toggle="modal" data-target="#invoiceHistory" href="#" onclick="invoiceHistory('+application.schedule[i - 2]['ID']+')">Payment History</a>\n' +
                                            '        <a class="dropdown-item" data-toggle="modal" data-target="#editHistory" href="#" onclick="editHistory('+application.schedule[i - 2]['ID']+')">Edit History</a>\n' +
                                            '        <a class="dropdown-item" href="#" onclick="writeOff('+application.schedule[i - 2]['ID']+')">Write Off</a>\n' +
                                            '    </div>\n' +
                                            '</div>');
                                    }
                                } else {
                                    cell.html('<div class="btn-group">\n' +
                                        '    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">\n' +
                                        '        <i class="fa fa-list"></i>\n' +
                                        '    </button>\n' +
                                        '    <div class="dropdown-menu">\n' +
                                        '        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#invoiceHistory" onclick="invoiceHistory('+application.schedule[i - 2]['ID']+')">Payment History</a>\n' +
                                        '        <a class="dropdown-item" data-toggle="modal" data-target="#editHistory" href="#" onclick="editHistory('+application.schedule[i - 2]['ID']+')">Edit History</a>\n' +
                                        '    </div>\n' +
                                        '</div>');
                                }
                            } else {
                                if (cells[j] !== "0" && cells[j] !== "0.00" && cells[j] !== 0 && cells[j] !== 0.00){
                                    cell = $("<td style='font-size: 14px;' />");
                                    cell.html('₦'+(parseFloat(cells[j])).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                                } else {
                                    cell.html('--');
                                }
                            }
                        }
                        row.append(cell);
                    }
                    table.append(row);
                }
                let row = $('<tr style="font-weight: bold;" />');
                for (let i = 0; i<total.length; i++){
                    let cell = $("<td />");
                    if (i === 0){
                        cell = $("<td colspan='5' />");
                        cell.html(total[i]);
                        row.append(cell);
                    } else if (i > 2){
                        cell.html('₦'+(parseFloat(total[i])).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                        row.append(cell);
                    }
                }
                table.append(row);
                $loanCollectionSchedule.html('');
                $loanCollectionSchedule.append(table);
            }
        }

        function totalPayment(a){
            return ((parseFloat(a.payment_amount)+parseFloat(a.interest_amount)+parseFloat(a.fees_amount)+parseFloat(a.penalty_amount)).round(2)).toString();
        }

        function totalActualPayment(a){
            return ((parseFloat(a.actual_payment_amount)+parseFloat(a.actual_interest_amount)+parseFloat(a.actual_fees_amount)+parseFloat(a.actual_penalty_amount)).round(2)).toString();
        }

        let invoice_id,
            expected_invoice;

        function confirmPaymentModal(id) {
            invoice_id = id;
            let invoice_obj = ($.grep(application.schedule, function (e) { return parseInt(e.ID) === parseInt(invoice_id) }))[0],
                invoice = $.extend({},invoice_obj);
            let payment_history = $.grep(application.payment_history,function(e) {return (e.invoiceID===parseInt(invoice_id) && e.status===1)});
            for (let k = 0; k < payment_history.length; k++){
                invoice.payment_amount -= parseFloat(payment_history[k]['payment_amount']);
                invoice.interest_amount -= parseFloat(payment_history[k]['interest_amount']);
            }
            expected_invoice = invoice;
            $('#source').val(0);
            $('#message').text('');
            $('#overpayment-message').text('');
//            $('#repayment-date').val(new Date().toDateInputValue());
            $('#principal').attr({max:invoice.payment_amount});
            $('#interest').attr({max:invoice.interest_amount});
            $('#principal-payable').text('₦'+(parseFloat(invoice.payment_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
            $('#interest-payable').text('₦'+(parseFloat(invoice.interest_amount)).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
        }

        $('#source').change(function () {
            let $payment = $('#payment');
            if (this.value === 'escrow'){
                $payment.val(0);
                $payment.prop('disabled',true);
            } else {
                $payment.prop('disabled',false);
            }
        });

        $('.validate').change(function () {
            let invoice = {},
                $message = $('#message'),
                $interest = $('#interest'),
                $principal = $('#principal'),
                $message2 = $('#overpayment-message'),
                $button = $('#confirm-payment-button'),
                payment = parseFloat($('#payment').val());
            invoice.actual_payment_amount = parseFloat($('#principal').val());
            invoice.actual_interest_amount = parseFloat($('#interest').val());

            if (invoice.actual_payment_amount > (parseFloat(expected_invoice.payment_amount)).round(2)){
                $message.text('Principal cannot be greater than '+expected_invoice.payment_amount);
                $button.prop('disabled', true);
                $interest.removeClass('error');
                $principal.addClass('error');
                $message.addClass('error');
            } else if (invoice.actual_interest_amount > (parseFloat(expected_invoice.interest_amount)).round(2)){
                $message.text('Interest cannot be greater than '+expected_invoice.interest_amount);
                $button.prop('disabled', true);
                $principal.removeClass('error');
                $interest.addClass('error');
                $message.addClass('error');
            } else {
                $button.prop('disabled', false);
                $principal.removeClass('error');
                $interest.removeClass('error');
                $message.text('');
            }

            let overpayment = (payment - (invoice.actual_payment_amount + invoice.actual_interest_amount)).round(2);
            if (overpayment > 0){
                $message2.text('Overpayment = ₦'+(parseFloat(overpayment).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')));
            } else {
                $message2.text('');
            }
        });

        Date.prototype.toDateInputValue = (function() {
            let local = new Date(this);
            local.setMinutes(this.getMinutes() - this.getTimezoneOffset());
            return local.toJSON().slice(0,10);
        });

        function confirmPayment() {
            let invoice = {},
                payment = parseFloat($('#payment').val() || '0');
            invoice.actual_payment_amount = $('#principal').val() || '0';
            invoice.actual_interest_amount = $('#interest').val() || '0';
            invoice.actual_fees_amount = $('#fees').val() || '0';
            invoice.actual_penalty_amount = $('#penalty').val() || '0';
            invoice.payment_source = $('#source').val();
            invoice.payment_date = $('#repayment-date').val();
            let total_payment = (parseFloat(invoice.actual_payment_amount)+parseFloat(invoice.actual_interest_amount)+parseFloat(invoice.actual_fees_amount)+parseFloat(invoice.actual_penalty_amount)).round(2);
            if (!invoice.payment_date)
                return swal('Kindly specify a payment date to proceed','','warning');
            if (invoice.payment_source === '0')
                return swal('Kindly select a payment source to proceed','','warning');
            application.escrow = application.escrow || "0";
            if (invoice.payment_source === 'escrow' && (total_payment > (parseFloat(application.escrow)).round(2)))
                return swal('Total Payment ('+total_payment+') must be less than or equal to escrow balance ('+parseFloat(application.escrow).round(2)+')','','warning');
            $('#wait').show();
            $('#confirmPayment').modal('hide');
            updateEscrow(invoice.payment_source, total_payment, function () {
                let overpayment = (payment - (parseFloat(invoice.actual_payment_amount) + parseFloat(invoice.actual_interest_amount))).round(2);
                if (overpayment > 0){
                    $('#wait').hide();
                    swal({
                        title: "Are you sure?",
                        text: "Overpayment of ₦"+(parseFloat(overpayment).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'))+" would be saved to escrow",
                        icon: "warning",
                        buttons: true,
                        dangerMode: true,
                    })
                        .then((yes) => {
                            if (yes) {
                                $('#wait').show();
                                $.ajax({
                                    'url': '/user/application/confirm-payment/'+invoice_id+'/'+application_id+'/'+(JSON.parse(localStorage.getItem('user_obj')))['ID'],
                                    'type': 'post',
                                    'data': invoice,
                                    'success': function (data) {
                                        $('#wait').hide();
                                        return escrow(overpayment);
                                    },
                                    'error': function (err) {
                                        $('#wait').hide();
                                        swal('Oops! An error occurred while confirming payment','','error');
                                    }
                                });
                            }
                        });
                } else {
                    $.ajax({
                        'url': '/user/application/confirm-payment/'+invoice_id+'/'+application_id+'/'+(JSON.parse(localStorage.getItem('user_obj')))['ID'],
                        'type': 'post',
                        'data': invoice,
                        'success': function (data) {
                            $('#wait').hide();
                            swal('Payment confirmed successfully','','success');
                            window.location.reload();
                        },
                        'error': function (err) {
                            $('#wait').hide();
                            swal('Oops! An error occurred while confirming payment','','error');
                        }
                    });
                }
            });
        }

        function updateEscrow(source, amount, callback) {
            if (source === 'escrow'){
                $.ajax({
                    'url': '/user/application/escrow',
                    'type': 'post',
                    'data': {clientID:application.userID,amount:amount*-1,type:'debit'},
                    'success': function (data) {
                        callback();
                    },
                    'error': function (err) {
                        swal('Oops! An error occurred while processing escrow payment','','error');
                    }
                });
            } else {
                callback();
            }
        }

        function escrow(amount) {
            $.ajax({
                'url': '/user/application/escrow',
                'type': 'post',
                'data': {clientID:application.userID,amount:amount},
                'success': function (data) {
                    swal('Payment confirmed successfully','Overpayment of ₦'+(parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'))+' has been credited to escrow','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('Oops! An error occurred while processing overpayment','','error');
                }
            });
        }

        let edit_invoice_id;

        function editScheduleModal(id) {
            edit_invoice_id = id;
            let $interest_invoice_div = $('#edit-interest-invoice-div'),
                $principal_invoice_div = $('#edit-principal-invoice-div'),
                invoice = ($.grep(application.schedule, function (e) { return parseInt(e.ID) === parseInt(edit_invoice_id) }))[0];
            if (invoice.principal_invoice_no){
                $principal_invoice_div.hide();
            } else {
                $principal_invoice_div.show();
            }
            if (invoice.interest_invoice_no){
                $interest_invoice_div.hide();
            } else {
                $interest_invoice_div.show();
            }
            $('#edit-principal').val(invoice.payment_amount);
            $('#edit-interest').val(invoice.interest_amount);
            $('#edit-fees').val(invoice.fees_amount);
            $('#edit-penalty').val(invoice.penalty_amount);
            $('#edit-principal-payment-date').val(processPaymentDate(invoice.payment_collect_date,2));
            $('#edit-principal-invoice-date').val(processPaymentDate(invoice.payment_create_date,2));
            $('#edit-interest-payment-date').val(processPaymentDate(invoice.interest_collect_date,2));
            $('#edit-interest-invoice-date').val(processPaymentDate(invoice.interest_create_date,2));
        }

        function editSchedule() {
            let invoice = {},
                $interest_invoice_no = $('#edit-interest-invoice-no'),
                $principal_invoice_no = $('#edit-principal-invoice-no');
            if ($interest_invoice_no.val())
                invoice.interest_invoice_no = $interest_invoice_no.val();
            if ($principal_invoice_no.val())
                invoice.principal_invoice_no = $principal_invoice_no.val();
            invoice.payment_amount = $('#edit-principal').val();
            invoice.interest_amount = $('#edit-interest').val();
            invoice.fees_amount = $('#edit-fees').val();
            invoice.penalty_amount = $('#edit-penalty').val();
            invoice.payment_collect_date = processPaymentDate($('#edit-principal-payment-date').val(),1);
            invoice.payment_create_date = processPaymentDate($('#edit-principal-invoice-date').val(),1);
            invoice.interest_collect_date = processPaymentDate($('#edit-interest-payment-date').val(),1);
            invoice.interest_create_date = processPaymentDate($('#edit-interest-invoice-date').val(),1);
            $('#wait').show();
            $('#editSchedule').modal('hide');
            $.ajax({
                'url': '/user/application/edit-schedule/'+edit_invoice_id+'/'+(JSON.parse(localStorage.getItem('user_obj')))['ID'],
                'type': 'post',
                'data': invoice,
                'success': function (data) {
                    $('#wait').hide();
                    swal('Schedule updated successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    $('#wait').hide();
                    swal('Oops! An error occurred while confirming payment','','error');
                }
            });
        }

        function invoiceHistory(invoice_id) {
            $.ajax({
                'url': '/user/application/invoice-history/'+invoice_id,
                'type': 'get',
                'success': function (data) {
                    $("#invoice-history").dataTable().fnClearTable();
                    $.each(data.response, function(k, v){
                        let table = [
                            v.ID,
                            v.payment_amount,
                            v.interest_amount,
                            v.fees_amount,
                            v.penalty_amount,
                            v.agent,
                            v.date_created
                        ];
                        if (v.status === 0){
                            table.push('Payment Reversed');
                        } else if (v.status === 1){
                            table.push('<button class="btn btn-danger" onclick="reversePayment('+v.ID+','+v.invoiceID+')"><i class="fa fa-remove"></i> Reverse</button>');
                        }
                        $('#invoice-history').dataTable().fnAddData(table);
                        $('#invoice-history').dataTable().fnSort([[0,'desc']]);
                    });
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }

        function escrowHistory() {
            $.ajax({
                'url': '/user/application/escrow-history/'+application.userID,
                'type': 'get',
                'success': function (data) {
                    $("#escrow-history").dataTable().fnClearTable();
                    $.each(data.response, function(k, v){
                        let table = [
                            v.amount,
                            v.type,
                            v.date_created
                        ];
                        if (v.status === 0){
                            table.push('Payment Reversed');
                        } else if (v.status === 1){
                            table.push('<button class="btn btn-danger" onclick="reverseEscrowPayment('+v.ID+')"><i class="fa fa-remove"></i> Reverse</button>');
                        }
                        $('#escrow-history').dataTable().fnAddData(table);
                        $('#escrow-history').dataTable().fnSort([[2,'desc']]);
                    });
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }

        function editHistory(invoice_id) {
            $.ajax({
                'url': '/user/application/edit-schedule-history/'+invoice_id,
                'type': 'get',
                'success': function (data) {
                    $("#edit-history").dataTable().fnClearTable();
                    $.each(data.response, function(k, v){
                        let table = [
                            v.payment_amount,
                            v.interest_amount,
                            v.fees_amount,
                            v.penalty_amount,
                            v.payment_collect_date,
                            v.modified_by,
                            v.date_modified
                        ];
                        $('#edit-history').dataTable().fnAddData(table);
                        $('#edit-history').dataTable().fnSort([[6,'desc']]);
                    });
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }

        function writeOff(invoice_id) {
            swal({
                title: "Are you sure?",
                text: "Once started, this process is not reversible!",
                icon: "warning",
                buttons: true,
                dangerMode: true,
            })
                .then((yes) => {
                    if (yes) {
                        $.ajax({
                            'url': '/user/application/schedule-history/write-off/'+invoice_id,
                            'type': 'get',
                            'success': function (data) {
                                swal('Invoice write off successful','','success');
                                window.location.reload();
                            },
                            'error': function (err) {
                                swal('No internet connection','','error');
                            }
                        });
                    }
                });
        }

        function reversePayment(payment_id,invoice_id) {
            $.ajax({
                'url': '/user/application/payment-reversal/'+payment_id+'/'+invoice_id,
                'type': 'get',
                'success': function (data) {
                    swal('Payment reversed successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }

        function reverseEscrowPayment(payment_id) {
            $.ajax({
                'url': '/user/application/escrow-payment-reversal/'+payment_id,
                'type': 'get',
                'success': function (data) {
                    swal('Payment reversed successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }

        function addPayment() {
            let payment = {};
            payment.interest_amount = $('#payment-interest').val();
//            payment.actual_interest_amount = $('#payment-interest').val();
            payment.interest_collect_date = $('#payment-date').val();
            payment.comment = $('#payment-notes').val();
            if (!payment.interest_amount || !payment.interest_collect_date)
                return swal('Kindly fill all required fields!','','warning');
            payment.interest_collect_date = processPaymentDate(payment.interest_collect_date,1);
            $.ajax({
                'url': '/user/application/add-payment/'+application_id+'/'+(JSON.parse(localStorage.getItem('user_obj')))['ID'],
                'type': 'post',
                'data': payment,
                'success': function (data) {
                    swal('Payment added successfully','','success');
                    window.location.reload();
                },
                'error': function (err) {
                    swal('No internet connection','','error');
                }
            });
        }
        
        function processPaymentDate(date,type) {
            return date;
//            let date_array = date.split('-');
//            switch (type){
//                case 1: {
//                    return date_array[2]+'-'+date_array[1]+'-'+date_array[0].substr(2,2);
//                }
//                case 2: {
//                    date_array[1] = (date_array[1].length === 1)? '0'+date_array[1] : date_array[1];
//                    return '20'+date_array[2]+'-'+date_array[1]+'-'+date_array[0];
//                }
//            }
        }

        Number.prototype.round = function(p) {
            p = p || 10;
            return parseFloat( this.toFixed(p) );
        };
    </script>
</body>
</html>
